<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Mes Recettes</title>
    <link rel="icon" type="image/svg+xml" href="favicon.svg">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .main-layout {
            display: flex;
            max-width: 1400px;
            margin: 0 auto;
            gap: 20px;
        }

        .sidebar {
            width: 280px;
            background: white;
            border-radius: 20px;
            padding: 24px 18px;
            box-shadow: 0 8px 24px rgba(0,0,0,0.08);
            height: fit-content;
            max-height: calc(100vh - 40px);
            overflow-y: auto;
            position: sticky;
            top: 20px;
        }

        .sidebar::-webkit-scrollbar {
            width: 5px;
        }

        .sidebar::-webkit-scrollbar-thumb {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border-radius: 10px;
        }

        .sidebar::-webkit-scrollbar-track {
            background: #f8f9ff;
            border-radius: 10px;
        }

        .sidebar-title {
            font-size: 1.4em;
            font-weight: 700;
            color: #667eea;
            margin-bottom: 20px;
            padding-bottom: 16px;
            border-bottom: 2px solid #f0f0f0;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .category-list {
            list-style: none;
        }

        .category-group {
            margin: 8px 0;
            border-bottom: 1px solid #f0f0f0;
            padding-bottom: 8px;
        }

        .category-group:last-child {
            border-bottom: none;
        }

        .category-item {
            padding: 14px 16px;
            border-radius: 10px;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-size: 0.95em;
            user-select: none;
            font-weight: 500;
            margin-bottom: 4px;
        }

        .category-item:hover {
            background: linear-gradient(135deg, #f8f9ff 0%, #f0f0ff 100%);
        }

        .category-item.active {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            font-weight: 600;
            box-shadow: 0 2px 8px rgba(102, 126, 234, 0.3);
        }

        .category-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            width: 100%;
        }

        .category-name {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .category-count {
            background: rgba(0,0,0,0.08);
            padding: 4px 10px;
            border-radius: 14px;
            font-size: 0.8em;
            font-weight: 600;
            min-width: 28px;
            text-align: center;
        }

        .category-item.active .category-count {
            background: rgba(255,255,255,0.25);
        }

        .category-arrow {
            font-size: 0.7em;
            transition: transform 0.3s ease;
            color: #999;
            font-weight: bold;
        }

        .category-item.active .category-arrow {
            color: white;
        }

        .category-item.expanded .category-arrow {
            transform: rotate(90deg);
        }

        .recipe-list {
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.4s ease, padding 0.3s ease;
            padding-left: 0;
            margin-left: 12px;
            border-left: 2px solid #e8e8ff;
        }

        .recipe-list.expanded {
            max-height: 1000px;
            padding-top: 8px;
            padding-bottom: 8px;
            padding-left: 12px;
        }

        .recipe-link {
            display: block;
            padding: 10px 14px;
            margin: 3px 0;
            border-radius: 8px;
            font-size: 0.88em;
            color: #555;
            cursor: pointer;
            transition: all 0.25s ease;
            background: white;
            border: 1px solid transparent;
        }

        .recipe-link:hover {
            background: linear-gradient(135deg, #f8f9ff 0%, #f0f0ff 100%);
            color: #667eea;
            border-color: #e0e0ff;
            transform: translateX(4px);
            box-shadow: 0 2px 6px rgba(102, 126, 234, 0.15);
        }

        .container {
            flex: 1;
            min-width: 0;
        }

        /* Menu burger pour mobile */
        .menu-toggle {
            display: none;
            position: fixed;
            top: 20px;
            left: 20px;
            z-index: 1001;
            background: white;
            border: none;
            border-radius: 50%;
            width: 50px;
            height: 50px;
            font-size: 24px;
            cursor: pointer;
            box-shadow: 0 4px 10px rgba(0,0,0,0.2);
        }

        @media (max-width: 968px) {
            .main-layout {
                flex-direction: column;
            }

            .sidebar {
                position: fixed;
                top: 0;
                left: -320px;
                height: 100vh;
                z-index: 1000;
                transition: left 0.3s ease;
                border-radius: 0 20px 20px 0;
                width: 280px;
                max-height: 100vh;
                box-shadow: 0 0 30px rgba(0,0,0,0.2);
            }

            .sidebar.open {
                left: 0;
            }

            .menu-toggle {
                display: flex;
                align-items: center;
                justify-content: center;
                animation: pulse 2s infinite;
            }

            @keyframes pulse {
                0%, 100% { transform: scale(1); }
                50% { transform: scale(1.05); }
            }

            .sidebar-overlay {
                display: none;
                position: fixed;
                top: 0;
                left: 0;
                right: 0;
                bottom: 0;
                background: rgba(0,0,0,0.5);
                z-index: 999;
                backdrop-filter: blur(2px);
            }

            .sidebar-overlay.show {
                display: block;
            }
        }

        h1 {
            text-align: center;
            color: white;
            margin-bottom: 30px;
            font-size: 2.5em;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
        }

        .header-controls {
            margin-bottom: 30px;
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 15px;
            flex-wrap: wrap;
        }

        .search-bar {
            flex: 1;
            max-width: 500px;
            min-width: 250px;
        }

        .search-bar input {
            width: 100%;
            padding: 15px;
            font-size: 16px;
            border: none;
            border-radius: 25px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }

        .add-recipe-btn {
            padding: 15px 30px;
            background: white;
            color: #667eea;
            border: none;
            border-radius: 25px;
            font-size: 16px;
            font-weight: bold;
            cursor: pointer;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            transition: all 0.3s ease;
            white-space: nowrap;
        }

        .add-recipe-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 12px rgba(0,0,0,0.2);
        }

        .add-recipe-btn:active {
            transform: translateY(0);
        }

        .loading {
            text-align: center;
            color: white;
            font-size: 1.2em;
            margin-top: 50px;
        }

        .error {
            background-color: #ff6b6b;
            color: white;
            padding: 20px;
            border-radius: 10px;
            text-align: center;
            margin: 20px auto;
            max-width: 600px;
        }

        .recipes-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 25px;
            margin-top: 30px;
        }

        .recipe-card {
            background: white;
            border-radius: 15px;
            padding: 25px;
            box-shadow: 0 8px 16px rgba(0,0,0,0.2);
            transition: transform 0.3s ease, box-shadow 0.3s ease;
            cursor: pointer;
        }

        .recipe-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 12px 24px rgba(0,0,0,0.3);
        }

        .recipe-name {
            font-size: 1.5em;
            color: #667eea;
            margin-bottom: 10px;
            font-weight: bold;
        }

        .recipe-category {
            display: inline-block;
            background: #667eea;
            color: white;
            padding: 5px 15px;
            border-radius: 20px;
            font-size: 0.9em;
            margin-bottom: 15px;
        }

        .recipe-info {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            margin-bottom: 15px;
        }

        .recipe-info-item {
            background: #f0f0f0;
            padding: 5px 10px;
            border-radius: 10px;
            font-size: 0.85em;
            color: #555;
        }

        .recipe-details {
            color: #555;
            line-height: 1.6;
        }

        .recipe-details p {
            margin: 8px 0;
        }

        .recipe-details strong {
            color: #333;
        }

        .recipe-section {
            margin-top: 15px;
            padding-top: 15px;
            border-top: 1px solid #e0e0e0;
        }

        .recipe-subsection {
            margin-top: 12px;
            margin-left: 15px;
            padding-left: 15px;
            border-left: 3px solid #667eea;
        }

        .section-title {
            color: #667eea;
            font-size: 1.05em;
            display: block;
            margin-bottom: 5px;
        }

        .no-results {
            text-align: center;
            color: white;
            font-size: 1.2em;
            margin-top: 50px;
        }

        .config-section {
            background: rgba(255, 255, 255, 0.95);
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 30px;
            text-align: center;
        }

        .config-section input {
            width: 100%;
            max-width: 600px;
            padding: 10px;
            margin: 10px 0;
            border: 2px solid #667eea;
            border-radius: 5px;
        }

        .config-section button {
            background: #667eea;
            color: white;
            padding: 10px 30px;
            border: none;
            border-radius: 25px;
            cursor: pointer;
            font-size: 16px;
            margin-top: 10px;
        }

        .config-section button:hover {
            background: #764ba2;
        }

        .stats {
            text-align: center;
            color: white;
            margin-bottom: 20px;
            font-size: 1.1em;
        }

        .filter-section {
            text-align: center;
            margin-bottom: 20px;
        }

        .filter-buttons {
            display: flex;
            flex-wrap: wrap;
            justify-content: center;
            gap: 10px;
            margin-top: 10px;
        }

        .filter-btn {
            background: rgba(255, 255, 255, 0.9);
            color: #667eea;
            padding: 8px 20px;
            border: 2px solid white;
            border-radius: 20px;
            cursor: pointer;
            font-size: 14px;
            transition: all 0.3s ease;
        }

        .filter-btn:hover {
            background: white;
            transform: scale(1.05);
        }

        .filter-btn.active {
            background: #667eea;
            color: white;
        }

        /* Modal pour vue détaillée */
        .modal-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.8);
            z-index: 1000;
            overflow-y: auto;
            padding: 20px;
        }

        .modal-overlay.active {
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .modal-content {
            background: white;
            border-radius: 20px;
            max-width: 800px;
            width: 100%;
            max-height: 90vh;
            overflow-y: auto;
            padding: 40px;
            position: relative;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            animation: modalFadeIn 0.3s ease;
        }

        @keyframes modalFadeIn {
            from {
                opacity: 0;
                transform: scale(0.9);
            }
            to {
                opacity: 1;
                transform: scale(1);
            }
        }

        .modal-close {
            position: absolute;
            top: 20px;
            right: 20px;
            background: #667eea;
            color: white;
            border: none;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            font-size: 24px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: transform 0.2s ease, background 0.2s ease;
        }

        .modal-close:hover {
            background: #764ba2;
            transform: rotate(90deg);
        }

        .modal-recipe-name {
            font-size: 2.5em;
            color: #667eea;
            margin-bottom: 15px;
            font-weight: bold;
            padding-right: 50px;
        }

        .modal-recipe-category {
            display: inline-block;
            background: #667eea;
            color: white;
            padding: 8px 20px;
            border-radius: 25px;
            font-size: 1em;
            margin-bottom: 20px;
        }

        .modal-recipe-info {
            display: flex;
            flex-wrap: wrap;
            gap: 15px;
            margin-bottom: 30px;
            padding-bottom: 20px;
            border-bottom: 2px solid #e0e0e0;
        }

        .modal-info-item {
            background: #f0f0f0;
            padding: 10px 20px;
            border-radius: 15px;
            font-size: 1em;
            color: #555;
        }

        .modal-section {
            margin-top: 30px;
        }

        .modal-section-title {
            font-size: 1.8em;
            color: #333;
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .modal-subsection {
            margin-top: 20px;
            margin-left: 20px;
            padding-left: 20px;
            border-left: 4px solid #667eea;
        }

        .modal-subsection-title {
            color: #667eea;
            font-size: 1.3em;
            font-weight: bold;
            margin-bottom: 10px;
        }

        .modal-content p {
            line-height: 1.8;
            color: #555;
            white-space: pre-line;
        }

        /* Optimisation mobile */
        @media (max-width: 768px) {
            .modal-overlay {
                padding: 0;
                align-items: flex-start;
            }

            .modal-content {
                max-width: 100%;
                width: 100%;
                max-height: 100vh;
                border-radius: 0;
                padding: 20px;
                margin: 0;
            }

            .modal-close {
                top: 10px;
                right: 10px;
                width: 35px;
                height: 35px;
                font-size: 20px;
            }

            .modal-recipe-name {
                font-size: 1.8em;
                padding-right: 40px;
                margin-bottom: 10px;
            }

            .modal-recipe-category {
                font-size: 0.9em;
                padding: 6px 15px;
            }

            .modal-recipe-info {
                gap: 10px;
                margin-bottom: 20px;
            }

            .modal-info-item {
                padding: 8px 15px;
                font-size: 0.9em;
            }

            .modal-section {
                margin-top: 20px;
            }

            .modal-section-title {
                font-size: 1.4em;
                margin-bottom: 12px;
            }

            .modal-subsection {
                margin-top: 15px;
                margin-left: 10px;
                padding-left: 15px;
                border-left: 3px solid #667eea;
            }

            .modal-subsection-title {
                font-size: 1.1em;
                margin-bottom: 8px;
            }

            .modal-content p {
                font-size: 0.95em;
                line-height: 1.7;
            }
        }

        /* Très petits écrans */
        @media (max-width: 480px) {
            .modal-recipe-name {
                font-size: 1.5em;
            }

            .modal-section-title {
                font-size: 1.2em;
            }

            .modal-subsection-title {
                font-size: 1em;
            }

            .modal-info-item {
                font-size: 0.85em;
                padding: 6px 12px;
            }
        }

        /* Panneau latéral coulissant pour ingrédients (mobile) */
        .ingredients-drawer {
            display: none;
            position: fixed;
            top: 0;
            left: -100%;
            width: 80%;
            max-width: 320px;
            height: 100vh;
            background: white;
            box-shadow: 2px 0 20px rgba(0,0,0,0.3);
            z-index: 2000;
            transition: left 0.3s ease;
            overflow-y: auto;
            padding: 20px;
        }

        .ingredients-drawer.open {
            left: 0;
        }

        .ingredients-drawer-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.5);
            z-index: 1999;
        }

        .ingredients-drawer-overlay.show {
            display: block;
        }

        .drawer-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 2px solid #667eea;
        }

        .drawer-title {
            font-size: 1.3em;
            color: #667eea;
            font-weight: bold;
        }

        .drawer-close {
            background: #667eea;
            color: white;
            border: none;
            border-radius: 50%;
            width: 35px;
            height: 35px;
            font-size: 20px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .drawer-section {
            margin-bottom: 20px;
        }

        .drawer-section-title {
            color: #667eea;
            font-weight: bold;
            font-size: 1.1em;
            margin-bottom: 10px;
        }

        .drawer-content {
            line-height: 1.7;
            color: #555;
            white-space: pre-line;
        }

        /* Bouton pour ouvrir le drawer */
        .open-ingredients-btn {
            display: none;
            position: fixed;
            bottom: 20px;
            right: 20px;
            background: #667eea;
            color: white;
            border: none;
            border-radius: 50%;
            width: 60px;
            height: 60px;
            font-size: 28px;
            cursor: pointer;
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.4);
            z-index: 1998;
            transition: transform 0.2s ease;
        }

        .open-ingredients-btn:active {
            transform: scale(0.9);
        }

        @media (max-width: 768px) {
            .ingredients-drawer {
                display: block;
            }
            
            .open-ingredients-btn {
                display: flex;
                align-items: center;
                justify-content: center;
            }
        }

        /* Mode étape par étape */
        .step-by-step-mode {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: white;
            z-index: 3000;
            overflow-y: auto;
        }

        .step-by-step-mode.active {
            display: block;
        }

        .step-header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }

        .step-header-title {
            font-size: 1.2em;
            font-weight: bold;
        }

        .step-header-actions {
            display: flex;
            gap: 10px;
            align-items: center;
        }

        .step-back-btn {
            background: rgba(255,255,255,0.2);
            color: white;
            border: none;
            border-radius: 10px;
            padding: 10px 15px;
            font-size: 0.9em;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 5px;
        }

        .step-back-btn:hover {
            background: rgba(255,255,255,0.3);
            transform: translateX(-2px);
        }

        @media (max-width: 768px) {
            .step-back-btn {
                font-size: 0.85em;
                padding: 8px 12px;
            }
        }

        .step-close-btn {
            background: rgba(255,255,255,0.2);
            color: white;
            border: none;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            font-size: 24px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .step-progress {
            background: #f0f0f0;
            padding: 15px 20px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            border-bottom: 1px solid #e0e0e0;
        }

        .step-counter {
            font-weight: bold;
            color: #667eea;
            font-size: 1.1em;
        }

        .step-progress-bar {
            flex: 1;
            height: 6px;
            background: #e0e0e0;
            border-radius: 10px;
            margin: 0 15px;
            overflow: hidden;
        }

        .step-progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #667eea 0%, #764ba2 100%);
            border-radius: 10px;
            transition: width 0.3s ease;
        }

        .step-content {
            padding: 30px 20px;
            min-height: calc(100vh - 240px);
            padding-bottom: 100px;
        }

        .step-section-title {
            color: #667eea;
            font-size: 0.9em;
            text-transform: uppercase;
            letter-spacing: 1px;
            margin-bottom: 10px;
            font-weight: bold;
        }

        .step-text {
            font-size: 1.4em;
            line-height: 1.8;
            color: #333;
            margin-bottom: 30px;
        }

        .step-ingredients-box {
            background: #f8f9ff;
            border-left: 4px solid #667eea;
            padding: 15px;
            margin-top: 20px;
            border-radius: 5px;
        }

        .step-ingredients-title {
            font-weight: bold;
            color: #667eea;
            margin-bottom: 10px;
        }

        .step-ingredients-list {
            font-size: 0.95em;
            line-height: 1.6;
            color: #555;
            white-space: pre-line;
        }

        .step-navigation {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            background: white;
            padding: 15px 20px;
            display: flex;
            gap: 10px;
            border-top: 2px solid #e0e0e0;
            box-shadow: 0 -2px 10px rgba(0,0,0,0.1);
        }

        .step-nav-btn {
            flex: 1;
            padding: 15px;
            border: none;
            border-radius: 10px;
            font-size: 1.1em;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .step-nav-btn:disabled {
            opacity: 0.3;
            cursor: not-allowed;
        }

        .step-prev-btn {
            background: #f0f0f0;
            color: #667eea;
        }

        .step-prev-btn:active:not(:disabled) {
            background: #e0e0e0;
        }

        .step-next-btn {
            background: #667eea;
            color: white;
        }

        .step-next-btn:active:not(:disabled) {
            background: #764ba2;
        }

        .step-finish-btn {
            background: #4CAF50;
            color: white;
        }

        .step-finish-btn:active {
            background: #45a049;
        }

        /* Bouton pour activer le mode */
        .activate-step-mode-btn {
            display: block;
            width: 100%;
            padding: 15px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            border-radius: 10px;
            font-size: 1.1em;
            font-weight: bold;
            cursor: pointer;
            margin-top: 20px;
            box-shadow: 0 4px 10px rgba(102, 126, 234, 0.3);
            transition: all 0.3s ease;
        }

        .activate-step-mode-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 15px rgba(102, 126, 234, 0.4);
        }

        .activate-step-mode-btn:active {
            transform: translateY(0);
        }

        /* Bouton pour voir tous les ingrédients en mode étape par étape */
        .step-all-ingredients-btn {
            position: fixed;
            bottom: 90px;
            right: 20px;
            width: 60px;
            height: 60px;
            background: linear-gradient(135deg, #4CAF50 0%, #45a049 100%);
            color: white;
            border: none;
            border-radius: 50%;
            font-size: 24px;
            cursor: pointer;
            box-shadow: 0 4px 15px rgba(76, 175, 80, 0.4);
            z-index: 3001;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s ease;
        }

        .step-all-ingredients-btn:hover {
            transform: scale(1.1);
            box-shadow: 0 6px 20px rgba(76, 175, 80, 0.5);
        }

        .step-all-ingredients-btn:active {
            transform: scale(0.95);
        }

        /* Drawer pour tous les ingrédients en mode étape par étape */
        .step-ingredients-drawer {
            position: fixed;
            top: 0;
            right: -100%;
            width: 350px;
            max-width: 90vw;
            height: 100%;
            background: white;
            box-shadow: -4px 0 15px rgba(0, 0, 0, 0.2);
            z-index: 3002;
            transition: right 0.3s ease;
            overflow-y: auto;
        }

        .step-ingredients-drawer.open {
            right: 0;
        }

        .step-drawer-header {
            background: linear-gradient(135deg, #4CAF50 0%, #45a049 100%);
            color: white;
            padding: 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            position: sticky;
            top: 0;
            z-index: 1;
        }

        .step-drawer-title {
            font-size: 1.2em;
            font-weight: bold;
        }

        .step-drawer-close {
            background: rgba(255,255,255,0.2);
            color: white;
            border: none;
            border-radius: 50%;
            width: 35px;
            height: 35px;
            font-size: 20px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .step-drawer-content {
            padding: 20px;
        }

        .step-drawer-section {
            margin-bottom: 25px;
        }

        .step-drawer-section-title {
            color: #4CAF50;
            font-weight: bold;
            font-size: 1.1em;
            margin-bottom: 10px;
            padding-bottom: 5px;
            border-bottom: 2px solid #4CAF50;
        }

        .step-drawer-section-content {
            white-space: pre-line;
            line-height: 1.6;
            color: #333;
        }

        .step-drawer-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.5);
            z-index: 3001;
            display: none;
        }

        .step-drawer-overlay.show {
            display: block;
        }

        @media (max-width: 768px) {
            .step-ingredients-drawer {
                width: 100%;
                max-width: 100%;
            }
        }

        /* Liste de courses */
        .shopping-list-mode {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: #f5f5f5;
            z-index: 3000;
            overflow-y: auto;
        }

        .shopping-list-mode.active {
            display: block;
        }

        .shopping-header {
            background: linear-gradient(135deg, #FF6B6B 0%, #EE5A6F 100%);
            color: white;
            padding: 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            position: sticky;
            top: 0;
            z-index: 10;
        }

        .shopping-header-title {
            font-size: 1.3em;
            font-weight: bold;
        }

        .shopping-header-actions {
            display: flex;
            gap: 10px;
            align-items: center;
        }

        .shopping-view-toggle {
            background: rgba(255,255,255,0.2);
            color: white;
            border: none;
            border-radius: 10px;
            padding: 8px 15px;
            font-size: 0.85em;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .shopping-view-toggle:hover {
            background: rgba(255,255,255,0.3);
        }

        .shopping-view-toggle.active {
            background: rgba(255,255,255,0.4);
        }

        .shopping-close-btn {
            background: rgba(255,255,255,0.2);
            color: white;
            border: none;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            font-size: 24px;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .shopping-close-btn:hover {
            background: rgba(255,255,255,0.3);
            transform: rotate(90deg);
        }

        .shopping-content {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }

        .shopping-empty {
            text-align: center;
            padding: 60px 20px;
            color: #999;
        }

        .shopping-empty-icon {
            font-size: 4em;
            margin-bottom: 20px;
        }

        .shopping-empty-text {
            font-size: 1.2em;
            margin-bottom: 10px;
        }

        .shopping-empty-hint {
            color: #bbb;
            font-size: 0.9em;
        }

        .shopping-section {
            background: white;
            border-radius: 15px;
            padding: 25px;
            margin-bottom: 25px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.05);
        }

        .shopping-section-title {
            font-size: 1.3em;
            font-weight: bold;
            margin-bottom: 20px;
            color: #333;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .shopping-section-count {
            background: #FF6B6B;
            color: white;
            font-size: 0.7em;
            padding: 4px 10px;
            border-radius: 15px;
        }

        .shopping-recipe-group {
            margin-bottom: 30px;
            padding-bottom: 25px;
            border-bottom: 2px solid #f0f0f0;
        }

        .shopping-recipe-group:last-child {
            border-bottom: none;
            margin-bottom: 0;
            padding-bottom: 0;
        }

        .shopping-recipe-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }

        .shopping-recipe-name {
            font-size: 1.1em;
            font-weight: 600;
            color: #FF6B6B;
        }

        .shopping-recipe-portions {
            font-size: 0.9em;
            color: #999;
            font-style: italic;
        }

        .shopping-recipe-delete {
            background: #ff4444;
            color: white;
            border: none;
            border-radius: 8px;
            padding: 6px 12px;
            font-size: 0.85em;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .shopping-recipe-delete:hover {
            background: #cc0000;
            transform: scale(1.05);
        }

        .shopping-ingredient {
            display: flex;
            align-items: center;
            padding: 10px;
            border-radius: 8px;
            transition: all 0.2s ease;
            margin-bottom: 5px;
        }

        .shopping-ingredient:hover {
            background: #f9f9f9;
        }

        .shopping-ingredient.checked {
            opacity: 0.6;
        }

        .shopping-ingredient.checked .shopping-ingredient-text {
            text-decoration: line-through;
            color: #999;
        }

        .shopping-ingredient-checkbox {
            width: 24px;
            height: 24px;
            cursor: pointer;
            margin-right: 12px;
            accent-color: #FF6B6B;
        }

        .shopping-ingredient-text {
            flex: 1;
            font-size: 0.95em;
            color: #333;
        }

        .shopping-category-group {
            margin-bottom: 30px;
        }

        .shopping-category-name {
            font-size: 1.1em;
            font-weight: 600;
            color: #FF6B6B;
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 2px solid #FFE0E0;
        }

        .shopping-actions {
            display: flex;
            gap: 15px;
            justify-content: center;
            margin-top: 30px;
        }

        .shopping-clear-btn {
            background: linear-gradient(135deg, #ff6b6b 0%, #ee5a6f 100%);
            color: white;
            border: none;
            border-radius: 10px;
            padding: 12px 30px;
            font-size: 1em;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 4px 15px rgba(255, 107, 107, 0.3);
        }

        .shopping-clear-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(255, 107, 107, 0.4);
        }

        .shopping-list-badge {
            background: #ff4444;
            color: white;
            font-size: 0.7em;
            padding: 3px 8px;
            border-radius: 10px;
            margin-left: 8px;
            font-weight: bold;
        }

        @media (max-width: 768px) {
            .shopping-header-title {
                font-size: 1.1em;
            }

            .shopping-view-toggle {
                font-size: 0.75em;
                padding: 6px 10px;
            }

            .shopping-content {
                padding: 15px;
            }

            .shopping-section {
                padding: 20px;
            }
        }

        /* Section d'ajout d'articles personnels */
        .shopping-add-section {
            background: white;
            border-radius: 15px;
            padding: 25px;
            margin: 25px auto 40px;
            max-width: 1200px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.05);
        }

        .shopping-add-title {
            font-size: 1.2em;
            font-weight: 600;
            color: #FF6B6B;
            margin-bottom: 15px;
            text-align: center;
        }

        .shopping-add-form {
            display: flex;
            gap: 15px;
            align-items: center;
        }

        .shopping-add-input {
            flex: 1;
            padding: 12px 20px;
            border: 2px solid #e0e0e0;
            border-radius: 10px;
            font-size: 1em;
            transition: all 0.3s ease;
        }

        .shopping-add-input:focus {
            outline: none;
            border-color: #FF6B6B;
            box-shadow: 0 0 0 3px rgba(255, 107, 107, 0.1);
        }

        .shopping-add-btn {
            background: linear-gradient(135deg, #FF6B6B 0%, #EE5A6F 100%);
            color: white;
            border: none;
            border-radius: 10px;
            padding: 12px 30px;
            font-size: 1em;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 4px 15px rgba(255, 107, 107, 0.3);
            white-space: nowrap;
        }

        .shopping-add-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(255, 107, 107, 0.4);
        }

        .shopping-add-btn:active {
            transform: translateY(0);
        }

        /* Styles pour le drag & drop */
        .drag-handle {
            cursor: grab;
            color: #ccc;
            font-size: 1.2em;
            padding: 5px 10px;
            user-select: none;
            display: inline-flex;
            align-items: center;
            transition: color 0.2s ease;
            -webkit-tap-highlight-color: transparent;
            touch-action: none;
        }

        .drag-handle:hover {
            color: #666;
        }

        .drag-handle:active {
            cursor: grabbing;
            color: #FF6B6B;
        }

        .shopping-ingredient.being-dragged {
            opacity: 0.5;
            background: #f0f0f0;
        }

        .shopping-ingredient.drag-placeholder {
            background: linear-gradient(90deg, #FF6B6B 0%, transparent 100%);
            border-left: 4px solid #FF6B6B;
            min-height: 50px;
        }

        /* Message vide pour "Autres achats" */
        .shopping-empty-custom {
            text-align: center;
            padding: 20px;
            color: #999;
            font-style: italic;
            font-size: 0.95em;
        }

        /* Formulaire d'ajout inline dans "Autres achats" */
        .shopping-add-inline {
            margin-top: 15px;
            padding-top: 15px;
            border-top: 2px dashed #e0e0e0;
        }

        @media (max-width: 768px) {
            .shopping-add-section {
                padding: 20px;
            }

            .shopping-add-form {
                flex-direction: column;
            }

            .shopping-add-input {
                width: 100%;
            }

            .shopping-add-btn {
                width: 100%;
            }
        }

        /* Modal d'import CSV */
        .import-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.7);
            z-index: 4000;
            align-items: center;
            justify-content: center;
        }

        .import-modal.active {
            display: flex;
        }

        .import-modal-content {
            background: white;
            border-radius: 15px;
            max-width: 700px;
            width: 90%;
            max-height: 80vh;
            overflow-y: auto;
            box-shadow: 0 10px 40px rgba(0,0,0,0.3);
        }

        .import-modal-header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px 30px;
            border-radius: 15px 15px 0 0;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .import-modal-title {
            font-size: 1.5em;
            font-weight: bold;
        }

        .import-modal-close {
            background: rgba(255,255,255,0.2);
            color: white;
            border: none;
            border-radius: 50%;
            width: 35px;
            height: 35px;
            font-size: 24px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .import-modal-body {
            padding: 30px;
        }

        .import-instructions {
            background: #f8f9ff;
            border-left: 4px solid #667eea;
            padding: 15px;
            margin-bottom: 20px;
            border-radius: 5px;
            font-size: 0.95em;
            line-height: 1.6;
        }

        .import-instructions strong {
            color: #667eea;
        }

        .csv-input-label {
            display: block;
            font-weight: bold;
            color: #333;
            margin-bottom: 10px;
        }

        .csv-textarea {
            width: 100%;
            min-height: 200px;
            padding: 15px;
            border: 2px solid #e0e0e0;
            border-radius: 10px;
            font-family: 'Courier New', monospace;
            font-size: 13px;
            resize: vertical;
            transition: border-color 0.3s ease;
        }

        .csv-textarea:focus {
            outline: none;
            border-color: #667eea;
        }

        .import-actions {
            display: flex;
            gap: 10px;
            margin-top: 20px;
        }

        .import-btn {
            flex: 1;
            padding: 15px;
            border: none;
            border-radius: 10px;
            font-size: 1em;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .import-btn-primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }

        .import-btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 15px rgba(102, 126, 234, 0.4);
        }

        .import-btn-secondary {
            background: #f0f0f0;
            color: #666;
        }

        .import-btn-secondary:hover {
            background: #e0e0e0;
        }

        .import-status {
            margin-top: 15px;
            padding: 15px;
            border-radius: 10px;
            display: none;
        }

        .import-status.success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
            display: block;
        }

        .import-status.error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
            display: block;
        }

        .import-status.loading {
            background: #d1ecf1;
            color: #0c5460;
            border: 1px solid #bee5eb;
            display: block;
        }

        /* Ajusteur de portions */
        .portion-adjuster {
            background: linear-gradient(135deg, #f8f9ff 0%, #fff 100%);
            border: 2px solid #667eea;
            border-radius: 15px;
            padding: 0;
            margin: 20px 0;
            box-shadow: 0 4px 15px rgba(102, 126, 234, 0.1);
            overflow: hidden;
            transition: all 0.3s ease;
        }

        .portion-adjuster-header {
            padding: 15px 20px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: space-between;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            transition: all 0.3s ease;
        }

        .portion-adjuster-header:hover {
            background: linear-gradient(135deg, #5568d3 0%, #653a8a 100%);
        }

        .portion-adjuster-header-text {
            display: flex;
            align-items: center;
            gap: 10px;
            font-weight: 600;
            font-size: 1.05em;
        }

        .portion-adjuster-toggle-icon {
            font-size: 1.2em;
            transition: transform 0.3s ease;
        }

        .portion-adjuster.collapsed .portion-adjuster-toggle-icon {
            transform: rotate(-90deg);
        }

        .portion-adjuster-content {
            padding: 20px;
            max-height: 500px;
            opacity: 1;
            transition: all 0.3s ease;
        }

        .portion-adjuster.collapsed .portion-adjuster-content {
            max-height: 0;
            opacity: 0;
            padding: 0 20px;
            overflow: hidden;
        }

        .portion-adjuster-title {
            font-size: 0.95em;
            font-weight: 600;
            color: #667eea;
            margin-bottom: 15px;
            text-align: center;
        }

        .portion-controls {
            display: flex;
            align-items: center;
            gap: 15px;
            justify-content: center;
        }

        .portion-btn {
            width: 45px;
            height: 45px;
            border: none;
            border-radius: 50%;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            font-size: 24px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 2px 8px rgba(102, 126, 234, 0.3);
        }

        .portion-btn:hover {
            transform: scale(1.1);
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.4);
        }

        .portion-btn:active {
            transform: scale(0.95);
        }

        .portion-display {
            flex: 1;
            text-align: center;
            padding: 0 20px;
        }

        .portion-number {
            font-size: 2.5em;
            font-weight: bold;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .portion-label {
            font-size: 0.95em;
            color: #666;
            margin-top: 5px;
        }

        .portion-original {
            font-size: 0.85em;
            color: #999;
            font-style: italic;
            margin-top: 8px;
        }

        .ingredient-adjusted {
            color: #667eea;
            font-weight: 500;
            transition: all 0.3s ease;
        }

        .portion-reset-btn {
            margin-top: 10px;
            padding: 8px 16px;
            background: #f0f0f0;
            border: none;
            border-radius: 8px;
            color: #666;
            font-size: 0.85em;
            cursor: pointer;
            transition: all 0.3s ease;
            margin-right: 10px;
        }

        .portion-reset-btn:hover {
            background: #e0e0e0;
            color: #667eea;
        }

        .portion-adjuster center {
            display: flex;
            justify-content: center;
            align-items: center;
            flex-wrap: wrap;
            gap: 10px;
        }

        /* Ajustement individuel d'ingrédients */
        .ingredient-line {
            padding: 5px 0;
            line-height: 1.6;
        }

        .editable-quantity {
            display: inline-block;
            padding: 2px 6px;
            border-radius: 4px;
            cursor: default;
            transition: all 0.2s ease;
            background: transparent;
            border: 1px solid transparent;
            min-width: 30px;
            text-align: center;
        }

        .edit-mode-active .editable-quantity {
            cursor: pointer;
            background: #fffef0;
            border-color: #fbbf24;
        }

        .edit-mode-active .editable-quantity:hover {
            background: #fef3c7;
            border-color: #f59e0b;
            box-shadow: 0 0 0 2px rgba(245, 158, 11, 0.2);
        }

        .editable-quantity:focus {
            outline: none;
            background: white;
            border-color: #f59e0b;
            box-shadow: 0 0 0 3px rgba(245, 158, 11, 0.3);
        }

        .edit-mode-toggle-btn {
            margin-top: 10px;
            padding: 10px 20px;
            background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%);
            color: white;
            border: none;
            border-radius: 10px;
            font-size: 0.95em;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            box-shadow: 0 2px 8px rgba(245, 158, 11, 0.3);
        }

        .edit-mode-toggle-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(245, 158, 11, 0.4);
        }

        .edit-mode-toggle-btn.active {
            background: linear-gradient(135deg, #10b981 0%, #059669 100%);
            box-shadow: 0 2px 8px rgba(16, 185, 129, 0.3);
        }

        .edit-mode-toggle-btn.active:hover {
            box-shadow: 0 4px 12px rgba(16, 185, 129, 0.4);
        }

        .edit-mode-banner {
            background: linear-gradient(135deg, #fef3c7 0%, #fde68a 100%);
            border: 2px solid #f59e0b;
            border-radius: 10px;
            padding: 12px 16px;
            margin-bottom: 15px;
            display: none;
            align-items: center;
            gap: 10px;
            font-size: 0.9em;
            color: #92400e;
            font-weight: 600;
            animation: slideIn 0.3s ease;
        }

        .edit-mode-active .edit-mode-banner {
            display: flex;
        }

        @keyframes slideIn {
            from {
                opacity: 0;
                transform: translateY(-10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .ingredient-modified-indicator {
            display: inline-block;
            width: 6px;
            height: 6px;
            background: #f59e0b;
            border-radius: 50%;
            margin-left: 4px;
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }
    </style>
</head>
<body>
    <!-- Bouton menu burger (mobile) -->
    <button class="menu-toggle" id="menuToggle" onclick="toggleSidebar()">
        ☰
    </button>

    <!-- Overlay pour fermer la sidebar sur mobile -->
    <div class="sidebar-overlay" id="sidebarOverlay" onclick="closeSidebar()"></div>

    <div class="main-layout">
        <!-- Sidebar avec les catégories -->
        <aside class="sidebar" id="sidebar">
            <div class="sidebar-title">
                📂 Catégories
            </div>
            <ul class="category-list" id="categoryList">
                <li class="category-item active" onclick="filterByCategory('all')">
                    <span>📚 Toutes les recettes</span>
                    <span class="category-count" id="count-all">0</span>
                </li>
            </ul>
            
            <div class="sidebar-title" style="margin-top: 30px;">
                🛒 Liste de courses
            </div>
            <ul class="category-list">
                <li class="category-item" onclick="openShoppingList()" style="cursor: pointer;">
                    <span>📝 Ma liste</span>
                    <span class="shopping-list-badge" id="shoppingListBadge" style="display: none;">0</span>
                </li>
            </ul>
        </aside>

        <!-- Contenu principal -->
        <div class="container">
            <h1>🍳 Mes Recettes</h1>

            <div class="config-section" id="configSection">
            <h3>Configuration</h3>
            <p>Entrez l'URL de votre Web App Google Apps Script :</p>
            <input type="text" id="webAppUrl" placeholder="https://script.google.com/macros/s/.../exec">
            <br>
            <button onclick="saveConfig()">Enregistrer</button>
            <br><br>
            <small style="color: #666;">
                Pour obtenir cette URL, déployez votre script Google Apps Script en tant que Web App.
                <br>Consultez le README.md pour plus d'instructions.
            </small>
        </div>

        <div id="mainContent" style="display: none;">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                <div class="stats" id="stats"></div>
                <button onclick="showConfigSection()" style="background: rgba(255,255,255,0.9); color: #667eea; padding: 8px 16px; border: none; border-radius: 20px; cursor: pointer; font-size: 14px;">
                    ⚙️ Changer l'URL
                </button>
            </div>

            <div class="header-controls">
                <div class="search-bar">
                    <input type="text" id="searchInput" placeholder="🔍 Rechercher une recette..." onkeyup="filterRecipes()">
                </div>
                <button class="add-recipe-btn" onclick="openImportModal()">
                    ➕ Ajouter une recette
                </button>
            </div>

            <div class="loading" id="loading" style="display: none;">
                Chargement des recettes...
            </div>

            <div id="error"></div>
            <div class="recipes-grid" id="recipesGrid"></div>
        </div>
    </div>

    <!-- Modal pour vue détaillée -->
    <div class="modal-overlay" id="recipeModal" onclick="closeRecipeModal()">
        <div class="modal-content" onclick="event.stopPropagation()">
            <button class="modal-close" onclick="closeRecipeModal()">×</button>
            <div id="modalRecipeContent"></div>
        </div>
    </div>

    <!-- Panneau latéral pour ingrédients (mobile) -->
    <div class="ingredients-drawer-overlay" id="ingredientsDrawerOverlay" onclick="closeIngredientsDrawer()"></div>
    <div class="ingredients-drawer" id="ingredientsDrawer">
        <div class="drawer-header">
            <div class="drawer-title">📋 Ingrédients</div>
            <button class="drawer-close" onclick="closeIngredientsDrawer()">×</button>
        </div>
        <div id="drawerIngredientsContent"></div>
    </div>

    <!-- Bouton flottant pour ouvrir le drawer -->
    <button class="open-ingredients-btn" id="openIngredientsBtn" onclick="openIngredientsDrawer()" style="display: none;">
        📋
    </button>

    <!-- Modal d'import CSV -->
    <div class="import-modal" id="importModal">
        <div class="import-modal-content" onclick="event.stopPropagation()">
            <div class="import-modal-header">
                <div class="import-modal-title">➕ Ajouter une nouvelle recette</div>
                <button class="import-modal-close" onclick="closeImportModal()">×</button>
            </div>
            <div class="import-modal-body">
                <div class="import-instructions">
                    <strong>📋 Comment importer votre recette :</strong><br>
                    1. Demandez à votre assistant GPT de générer le CSV<br>
                    2. Copiez le CSV complet (en-tête + données)<br>
                    3. Collez-le ci-dessous<br>
                    4. Cliquez sur "Importer la recette"
                </div>
                
                <label class="csv-input-label">Collez votre CSV ici :</label>
                <textarea 
                    id="csvTextarea" 
                    class="csv-textarea" 
                    placeholder='Nom,Catégorie,Portions,Temps de préparation,Temps de cuisson,Difficulté,Ingrédients - Pâte,...
"Ma recette","Plat principal","4 personnes","30 min","45 min","Moyen","- 200g de farine..."'
                ></textarea>
                
                <div class="import-actions">
                    <button class="import-btn import-btn-secondary" onclick="closeImportModal()">
                        Annuler
                    </button>
                    <button class="import-btn import-btn-primary" onclick="importRecipeFromCSV()">
                        ✅ Importer la recette
                    </button>
                </div>
                
                <div class="import-status" id="importStatus"></div>
            </div>
        </div>
    </div>

        </div> <!-- fin container -->
    </div> <!-- fin main-layout -->

    <!-- Mode étape par étape -->
    <div class="step-by-step-mode" id="stepByStepMode">
        <div class="step-header">
            <div class="step-header-title" id="stepHeaderTitle">Mode Étape par Étape</div>
            <div class="step-header-actions">
                <button class="step-back-btn" onclick="backToRecipe()">
                    ← Retour à la recette
                </button>
                <button class="step-close-btn" onclick="closeStepByStep()">×</button>
            </div>
        </div>
        
        <div class="step-progress">
            <div class="step-counter" id="stepCounter">Étape 1/1</div>
            <div class="step-progress-bar">
                <div class="step-progress-fill" id="stepProgressFill" style="width: 0%"></div>
            </div>
        </div>
        
        <div class="step-content" id="stepContent">
            <div class="step-section-title" id="stepSectionTitle"></div>
            <div class="step-text" id="stepText"></div>
            <div class="step-ingredients-box" id="stepIngredientsBox" style="display: none;">
                <div class="step-ingredients-title">📋 Ingrédients pour cette étape :</div>
                <div class="step-ingredients-list" id="stepIngredientsList"></div>
            </div>
        </div>
        
        <div class="step-navigation">
            <button class="step-nav-btn step-prev-btn" id="stepPrevBtn" onclick="previousStep()">← Précédent</button>
            <button class="step-nav-btn step-next-btn" id="stepNextBtn" onclick="nextStep()">Suivant →</button>
        </div>

        <!-- Bouton pour voir tous les ingrédients -->
        <button class="step-all-ingredients-btn" id="stepAllIngredientsBtn" onclick="openStepIngredientsDrawer()" style="display: none;">
            📋
        </button>

        <!-- Drawer avec tous les ingrédients -->
        <div class="step-drawer-overlay" id="stepDrawerOverlay" onclick="closeStepIngredientsDrawer()"></div>
        <div class="step-ingredients-drawer" id="stepIngredientsDrawer">
            <div class="step-drawer-header">
                <div class="step-drawer-title">📋 Tous les Ingrédients</div>
                <button class="step-drawer-close" onclick="closeStepIngredientsDrawer()">×</button>
            </div>
            <div class="step-drawer-content" id="stepDrawerContent"></div>
        </div>
    </div>

    <!-- Liste de courses -->
    <div class="shopping-list-mode" id="shoppingListMode">
        <div class="shopping-header">
            <div class="shopping-header-title">🛒 Ma Liste de Courses</div>
            <div class="shopping-header-actions">
                <button class="shopping-view-toggle" id="shoppingViewToggle" onclick="toggleShoppingView()">
                    <span id="shoppingViewText">🔀 Vue personnalisée</span>
                </button>
                <button class="shopping-close-btn" onclick="closeShoppingList()">×</button>
            </div>
        </div>

        <div class="shopping-content" id="shoppingContent">
            <div class="shopping-empty">
                <div class="shopping-empty-icon">🛒</div>
                <div class="shopping-empty-text">Votre liste de courses est vide</div>
                <div class="shopping-empty-hint">Ajoutez des recettes pour commencer</div>
            </div>
        </div>
    </div>

    <script>
        let allRecipes = [];
        let filteredRecipes = [];
        let activeCategory = 'all';
        
        // ⚙️ CONFIGURATION : Remplacez cette URL par celle de votre Web App Google Apps Script
        const DEFAULT_WEB_APP_URL = 'https://script.google.com/macros/s/AKfycbxgK2cGOJ38dt5dz8sH0kpmJxIFmnlFfFnGELQbaXxldNk-PVRVM71IexafmWxb4gfZbw/exec'; // <- Remplacez par votre URL

        // ===== LISTE DE COURSES =====
        let shoppingList = {
            recipes: [],
            flatOrder: []  // Ordre personnalisé pour la vue liste plate: [{recipeId, ingredientId}, ...]
        };
        let shoppingListViewMode = 'recipe'; // 'recipe' ou 'flat'
        
        let webAppUrl = localStorage.getItem('webAppUrl') || DEFAULT_WEB_APP_URL;

        // Variables pour le mode étape par étape
        let stepByStepData = {
            recipe: null,
            steps: [],
            currentStepIndex: 0
        };
        let currentRecipeForStepMode = null; // Stockage temporaire pour éviter les problèmes de sérialisation

        // Vérifier si l'URL est configurée au chargement
        window.addEventListener('DOMContentLoaded', () => {
            // Toujours masquer la config et charger les recettes
            document.getElementById('configSection').style.display = 'none';
            document.getElementById('mainContent').style.display = 'block';
            
            // Si l'URL par défaut n'a pas été remplacée, afficher un message
            if (webAppUrl === 'VOTRE_URL_ICI') {
                document.getElementById('error').innerHTML = `
                    <div class="error">
                        <strong>Configuration requise</strong><br>
                        Veuillez configurer l'URL de votre Web App dans le fichier index.html<br>
                        ou cliquez sur le bouton ci-dessous pour la configurer.<br><br>
                        <button onclick="showConfigSection()" style="padding: 10px 20px; background: white; color: #667eea; border: none; border-radius: 5px; cursor: pointer; font-size: 16px;">
                            ⚙️ Configurer l'URL
                        </button>
                    </div>
                `;
            } else {
                loadRecipes();
            }
        });

        function showConfigSection() {
            document.getElementById('configSection').style.display = 'block';
            document.getElementById('mainContent').style.display = 'none';
            document.getElementById('webAppUrl').value = webAppUrl === 'VOTRE_URL_ICI' ? '' : webAppUrl;
        }

        function saveConfig() {
            const url = document.getElementById('webAppUrl').value.trim();
            if (url) {
                localStorage.setItem('webAppUrl', url);
                webAppUrl = url;
                document.getElementById('configSection').style.display = 'none';
                document.getElementById('mainContent').style.display = 'block';
                document.getElementById('error').innerHTML = '';
                loadRecipes();
            } else {
                alert('Veuillez entrer une URL valide');
            }
        }

        async function loadRecipes() {
            const loading = document.getElementById('loading');
            const error = document.getElementById('error');
            const recipesGrid = document.getElementById('recipesGrid');

            loading.style.display = 'block';
            error.innerHTML = '';
            recipesGrid.innerHTML = '';

            try {
                const response = await fetch(webAppUrl);
                if (!response.ok) {
                    throw new Error('Erreur lors du chargement des recettes');
                }

                const data = await response.json();
                allRecipes = data.recipes || [];
                console.log('Recettes reçues:', allRecipes);
console.log('Première recette:', allRecipes[0]);
                filteredRecipes = allRecipes;

                loading.style.display = 'none';

                if (allRecipes.length === 0) {
                    recipesGrid.innerHTML = '<div class="no-results">Aucune recette trouvée. Commencez par créer votre première recette dans Google Sheets !</div>';
                    return;
                }

                updateStats();
                createCategoryFilters();
                displayRecipes(allRecipes);
                
                // Charger la liste de courses après le chargement des recettes
                loadShoppingListFromStorage();

            } catch (err) {
                loading.style.display = 'none';
                error.innerHTML = `
                    <div class="error">
                        <strong>Erreur :</strong> ${err.message}<br>
                        <small>Vérifiez que votre Web App est correctement déployée et accessible.</small><br>
                        <button onclick="location.reload()" style="margin-top: 10px; padding: 10px 20px; background: white; color: #ff6b6b; border: none; border-radius: 5px; cursor: pointer;">
                            Recharger
                        </button>
                        <button onclick="reconfigureApp()" style="margin-top: 10px; padding: 10px 20px; background: white; color: #667eea; border: none; border-radius: 5px; cursor: pointer; margin-left: 10px;">
                            Reconfigurer
                        </button>
                    </div>
                `;
            }
        }

        function reconfigureApp() {
            localStorage.removeItem('webAppUrl');
            location.reload();
        }

        function updateStats() {
            const stats = document.getElementById('stats');
            stats.innerHTML = `📚 ${allRecipes.length} recette${allRecipes.length > 1 ? 's' : ''} disponible${allRecipes.length > 1 ? 's' : ''}`;
        }

        function createCategoryFilters() {
            const categoriesMap = {};
            
            // Grouper les recettes par catégorie
            allRecipes.forEach(recipe => {
                const cat = recipe.categorie || 'Sans catégorie';
                if (!categoriesMap[cat]) {
                    categoriesMap[cat] = [];
                }
                categoriesMap[cat].push(recipe);
            });

            // Mettre à jour le compte "Toutes les recettes"
            document.getElementById('count-all').textContent = allRecipes.length;

            // Créer la liste des catégories
            const categoryList = document.getElementById('categoryList');
            let html = `
                <li class="category-item active" onclick="filterByCategory('all', event)" style="margin-bottom: 12px;">
                    <div class="category-header">
                        <div class="category-name">
                            <span>📚 Toutes les recettes</span>
                        </div>
                        <span class="category-count" id="count-all">${allRecipes.length}</span>
                    </div>
                </li>
            `;

            // Emoji par catégorie
            const categoryEmojis = {
                'Entrée': '🥗',
                'Plat principal': '🍽️',
                'Accompagnement': '🥘',
                'Dessert': '🍰',
                'Boisson': '🍹',
                'Sauce': '🥫',
                'Petit-déjeuner': '🥐',
                'Goûter': '🧁',
                'Apéritif': '🍸'
            };

            // Trier les catégories alphabétiquement
            const sortedCategories = Object.keys(categoriesMap).sort();

            sortedCategories.forEach(cat => {
                const recipes = categoriesMap[cat];
                const emoji = categoryEmojis[cat] || '📖';
                const safeCat = cat.replace(/'/g, "\\'");
                const categoryId = 'cat-' + cat.replace(/[^a-zA-Z0-9]/g, '-');
                
                // Trier les recettes par ordre alphabétique
                const sortedRecipes = recipes.sort((a, b) => 
                    (a.nom || '').localeCompare(b.nom || '')
                );
                
                html += `
                    <li class="category-group">
                        <div class="category-item" onclick="toggleCategory('${categoryId}', '${safeCat}', event)">
                            <div class="category-header">
                                <div class="category-name">
                                    <span>${emoji} ${cat}</span>
                                    <span class="category-arrow">▶</span>
                                </div>
                                <span class="category-count">${recipes.length}</span>
                            </div>
                        </div>
                        <div class="recipe-list" id="${categoryId}">
                `;
                
                // Ajouter chaque recette
                sortedRecipes.forEach(recipe => {
                    const recipeIndex = allRecipes.indexOf(recipe);
                    html += `
                        <div class="recipe-link" onclick="openRecipeFromMenu(${recipeIndex}); event.stopPropagation();">
                            ${recipe.nom || 'Sans nom'}
                        </div>
                    `;
                });
                
                html += `
                        </div>
                    </li>
                `;
            });

            categoryList.innerHTML = html;
        }

        function toggleCategory(categoryId, categoryName, event) {
            if (event) event.stopPropagation();
            
            const categoryElement = document.getElementById(categoryId);
            const categoryItem = event.target.closest('.category-item');
            
            // Toggle expanded class
            const isExpanded = categoryElement.classList.contains('expanded');
            categoryItem.classList.toggle('expanded');
            categoryElement.classList.toggle('expanded');
            
            // Si on ouvre la catégorie, filtrer aussi les recettes
            if (!isExpanded) {
                filterByCategory(categoryName, event);
            }
        }

        function openRecipeFromMenu(recipeIndex) {
            const recipe = allRecipes[recipeIndex];
            if (recipe) {
                openRecipeModal(recipe);
                closeSidebar(); // Fermer la sidebar sur mobile
            }
        }

        function filterByCategory(category, event) {
            activeCategory = category;

            // Mettre à jour les items actifs dans la sidebar
            if (event) {
                document.querySelectorAll('.category-item').forEach(item => {
                    item.classList.remove('active');
                });
                event.target.closest('.category-item').classList.add('active');
            }

            // Filtrer les recettes
            if (category === 'all') {
                filteredRecipes = allRecipes;
            } else {
                filteredRecipes = allRecipes.filter(recipe => recipe.categorie === category);
            }

            // Appliquer aussi le filtre de recherche si présent
            const searchTerm = document.getElementById('searchInput').value;
            if (searchTerm) {
                filterRecipes();
            } else {
                displayRecipes(filteredRecipes);
            }
        }

        // Fonctions pour gérer la sidebar sur mobile
        function toggleSidebar() {
            const sidebar = document.getElementById('sidebar');
            const overlay = document.getElementById('sidebarOverlay');
            sidebar.classList.toggle('open');
            overlay.classList.toggle('show');
        }

        function closeSidebar() {
            const sidebar = document.getElementById('sidebar');
            const overlay = document.getElementById('sidebarOverlay');
            sidebar.classList.remove('open');
            overlay.classList.remove('show');
        }

        function displayRecipes(recipes) {
            const recipesGrid = document.getElementById('recipesGrid');
            recipesGrid.innerHTML = '';

            recipes.forEach(recipe => {
                const card = document.createElement('div');
                card.className = 'recipe-card';
                
                let infoItems = '';
                if (recipe.portions) infoItems += `<span class="recipe-info-item">👥 ${recipe.portions}</span>`;
                if (recipe.tempsPreparation) infoItems += `<span class="recipe-info-item">⏱️ ${recipe.tempsPreparation}</span>`;
                if (recipe.tempsCuisson) infoItems += `<span class="recipe-info-item">🔥 ${recipe.tempsCuisson}</span>`;
                if (recipe.difficulte) infoItems += `<span class="recipe-info-item">📊 ${recipe.difficulte}</span>`;

                let html = `
                    <div class="recipe-name">${recipe.nom || 'Sans nom'}</div>
                    ${recipe.categorie ? `<span class="recipe-category">${recipe.categorie}</span>` : ''}
                    ${infoItems ? `<div class="recipe-info">${infoItems}</div>` : ''}
                `;

                // Affichage des ingrédients (avec ou sans sections)
                if (recipe.ingredientsSections && recipe.ingredientsSections.length > 0) {
                    html += `<div class="recipe-section"><strong>📋 Ingrédients :</strong></div>`;
                    recipe.ingredientsSections.forEach(section => {
                        html += `
                            <div class="recipe-subsection">
                                <strong class="section-title">${section.title} :</strong>
                                <p style="white-space: pre-line;">${section.content}</p>
                            </div>
                        `;
                    });
                } else if (recipe.ingredients) {
                    html += `
                        <div class="recipe-section">
                            <strong>📋 Ingrédients :</strong>
                            <p style="white-space: pre-line;">${recipe.ingredients}</p>
                        </div>
                    `;
                }

                // Bouton pour voir les détails
                html += `
                    <div style="margin-top: 15px; padding-top: 15px; border-top: 1px solid #eee; text-align: center;">
                        <span style="color: #667eea; font-size: 0.9em; font-weight: 500;">
                            👁️ Cliquez pour voir la préparation complète
                        </span>
                    </div>
                `;

                card.innerHTML = html;
                card.onclick = () => openRecipeModal(recipe);
                recipesGrid.appendChild(card);
            });
        }

        function openRecipeModal(recipe) {
            const modal = document.getElementById('recipeModal');
            const content = document.getElementById('modalRecipeContent');
            
            let infoItems = '';
            if (recipe.portions) infoItems += `<span class="modal-info-item">👥 ${recipe.portions}</span>`;
            if (recipe.tempsPreparation) infoItems += `<span class="modal-info-item">⏱️ ${recipe.tempsPreparation}</span>`;
            if (recipe.tempsCuisson) infoItems += `<span class="modal-info-item">🔥 ${recipe.tempsCuisson}</span>`;
            if (recipe.difficulte) infoItems += `<span class="modal-info-item">📊 ${recipe.difficulte}</span>`;

            let html = `
                <div class="modal-recipe-name">${recipe.nom || 'Sans nom'}</div>
                ${recipe.categorie ? `<span class="modal-recipe-category">${recipe.categorie}</span>` : ''}
                ${infoItems ? `<div class="modal-recipe-info">${infoItems}</div>` : ''}
            `;

            // Ajusteur de portions
            const originalPortions = extractPortionNumber(recipe.portions);
            if (originalPortions && (recipe.ingredientsSections || recipe.ingredients)) {
                html += `
                    <div class="portion-adjuster collapsed" id="portionAdjuster">
                        <div class="portion-adjuster-header" onclick="togglePortionAdjuster()">
                            <div class="portion-adjuster-header-text">
                                <span>🔢</span>
                                <span>Ajuster les quantités</span>
                            </div>
                            <span class="portion-adjuster-toggle-icon">▼</span>
                        </div>
                        <div class="portion-adjuster-content">
                            <div class="edit-mode-banner">
                                ✏️ Mode édition actif : Cliquez sur les quantités pour les modifier
                            </div>
                            <div class="portion-adjuster-title">
                                Nombre de portions
                            </div>
                            <div class="portion-controls">
                                <button class="portion-btn" onclick="adjustPortion(-1)">−</button>
                                <div class="portion-display">
                                    <div class="portion-number" id="currentPortions">${originalPortions}</div>
                                    <div class="portion-label">personne(s)</div>
                                    <div class="portion-original">Original : ${recipe.portions}</div>
                                </div>
                                <button class="portion-btn" onclick="adjustPortion(1)">+</button>
                            </div>
                            <center>
                                <button class="portion-reset-btn" onclick="resetPortions()">↻ Réinitialiser</button>
                                <button class="edit-mode-toggle-btn" id="editModeToggle" onclick="toggleEditMode()">
                                    <span id="editModeIcon">✏️</span>
                                    <span id="editModeText">Modifier les quantités</span>
                                </button>
                            </center>
                        </div>
                    </div>
                `;
            }

            // Bouton Ajouter à la liste de courses
            if (recipe.ingredientsSections || recipe.ingredients) {
                const recipeInList = shoppingList.recipes.find(r => r.name === recipe.nom);
                if (recipeInList) {
                    html += `
                        <div style="text-align: center; margin: 20px 0;">
                            <div style="padding: 15px; background: #e8f5e9; border-radius: 10px; color: #2e7d32; font-weight: 600;">
                                ✓ Cette recette est déjà dans votre liste de courses
                            </div>
                        </div>
                    `;
                } else {
                    html += `
                        <div style="text-align: center; margin: 20px 0;">
                            <button onclick="addRecipeToShoppingListFromModal()" style="
                                background: linear-gradient(135deg, #FF6B6B 0%, #EE5A6F 100%);
                                color: white;
                                border: none;
                                border-radius: 12px;
                                padding: 15px 30px;
                                font-size: 1em;
                                font-weight: 600;
                                cursor: pointer;
                                box-shadow: 0 4px 15px rgba(255, 107, 107, 0.3);
                                transition: all 0.3s ease;
                            " onmouseover="this.style.transform='translateY(-2px)'; this.style.boxShadow='0 6px 20px rgba(255, 107, 107, 0.4)'"
                               onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='0 4px 15px rgba(255, 107, 107, 0.3)'">
                                🛒 Ajouter à la liste de courses
                            </button>
                        </div>
                    `;
                }
            }

            // Affichage des ingrédients (avec IDs pour l'ajustement)
            if (recipe.ingredientsSections && recipe.ingredientsSections.length > 0) {
                html += `<div class="modal-section"><div class="modal-section-title">📋 Ingrédients</div>`;
                recipe.ingredientsSections.forEach((section, index) => {
                    html += `
                        <div class="modal-subsection">
                            <div class="modal-subsection-title">${section.title}</div>
                            <p id="ingredients-section-${index}">${section.content}</p>
                        </div>
                    `;
                });
                html += `</div>`;
            } else if (recipe.ingredients) {
                html += `
                    <div class="modal-section">
                        <div class="modal-section-title">📋 Ingrédients</div>
                        <p id="ingredients-simple">${recipe.ingredients}</p>
                    </div>
                `;
            }

            // Affichage de la préparation
            if (recipe.preparationSections && recipe.preparationSections.length > 0) {
                html += `<div class="modal-section"><div class="modal-section-title">👨‍🍳 Préparation</div>`;
                recipe.preparationSections.forEach(section => {
                    html += `
                        <div class="modal-subsection">
                            <div class="modal-subsection-title">${section.title}</div>
                            <p>${section.content}</p>
                        </div>
                    `;
                });
                html += `</div>`;
            } else if (recipe.preparation) {
                html += `
                    <div class="modal-section">
                        <div class="modal-section-title">👨‍🍳 Préparation</div>
                        <p>${recipe.preparation}</p>
                    </div>
                `;
            }

            // Notes
            if (recipe.notes) {
                html += `
                    <div class="modal-section">
                        <div class="modal-section-title">💡 Notes</div>
                        <p style="font-style: italic;">${recipe.notes}</p>
                    </div>
                `;
            }

            // Source
            if (recipe.source) {
                html += `
                    <div style="margin-top: 30px; padding-top: 20px; border-top: 1px solid #e0e0e0; font-size: 0.9em; color: #999;">
                        Source : ${recipe.source}
                    </div>
                `;
            }

            // Bouton mode étape par étape (uniquement si il y a des étapes de préparation)
            if ((recipe.preparationSections && recipe.preparationSections.length > 0) || recipe.preparation) {
                html += `
                    <button class="activate-step-mode-btn" onclick="startStepByStep()">
                        ▶️ Mode Étape par Étape
                    </button>
                `;
            }

            content.innerHTML = html;
            
            // Stocker la recette pour le mode étape par étape
            currentRecipeForStepMode = recipe;
            
            // Stocker les données originales pour l'ajustement de portions
            storeOriginalPortionData(recipe);
            
            // Préparer le contenu du drawer pour mobile
            prepareIngredientsDrawer(recipe);
            
            modal.classList.add('active');
            document.body.style.overflow = 'hidden'; // Empêcher le scroll du body
            
            // Cacher le bouton menu sur mobile
            const menuToggle = document.getElementById('menuToggle');
            if (menuToggle) menuToggle.style.display = 'none';
        }

        function prepareIngredientsDrawer(recipe) {
            const drawerContent = document.getElementById('drawerIngredientsContent');
            const openBtn = document.getElementById('openIngredientsBtn');
            
            if (!recipe.ingredientsSections && !recipe.ingredients) {
                openBtn.style.display = 'none';
                return;
            }
            
            let html = '';
            
            // Affichage des ingrédients dans le drawer avec quantités ajustées
            if (recipe.ingredientsSections && recipe.ingredientsSections.length > 0) {
                recipe.ingredientsSections.forEach((section, index) => {
                    const adjustedContent = getAdjustedIngredientsContent(`ingredients-section-${index}`);
                    html += `
                        <div class="drawer-section">
                            <div class="drawer-section-title">${section.title}</div>
                            <div class="drawer-content">${adjustedContent || section.content}</div>
                        </div>
                    `;
                });
            } else if (recipe.ingredients) {
                const adjustedContent = getAdjustedIngredientsContent('ingredients-simple');
                html += `
                    <div class="drawer-section">
                        <div class="drawer-content">${adjustedContent || recipe.ingredients}</div>
                    </div>
                `;
            }
            
            drawerContent.innerHTML = html;
            openBtn.style.display = window.innerWidth <= 768 ? 'flex' : 'none';
        }

        function getAdjustedIngredientsContent(ingredientId) {
            const element = document.getElementById(ingredientId);
            if (!element) return null;
            
            // Extraire le texte des quantités ajustées (sans les indicateurs)
            const lines = [];
            element.querySelectorAll('.ingredient-line').forEach(line => {
                // Cloner le nœud pour manipulation
                const clone = line.cloneNode(true);
                
                // Supprimer les indicateurs de modification
                const indicators = clone.querySelectorAll('.ingredient-modified-indicator');
                indicators.forEach(ind => ind.remove());
                
                let text = clone.textContent.trim();
                if (text) {
                    // Ne pas ajouter de tiret si la ligne commence déjà par un
                    if (!text.startsWith('-')) {
                        text = '- ' + text;
                    }
                    lines.push(text);
                }
            });
            
            return lines.length > 0 ? lines.join('<br>') : null;
        }

        function openIngredientsDrawer() {
            document.getElementById('ingredientsDrawer').classList.add('open');
            document.getElementById('ingredientsDrawerOverlay').classList.add('show');
        }

        function closeIngredientsDrawer() {
            document.getElementById('ingredientsDrawer').classList.remove('open');
            document.getElementById('ingredientsDrawerOverlay').classList.remove('show');
        }

        function closeRecipeModal() {
            const modal = document.getElementById('recipeModal');
            modal.classList.remove('active');
            document.body.style.overflow = 'auto';
            
            // Fermer aussi le drawer et masquer le bouton
            closeIngredientsDrawer();
            document.getElementById('openIngredientsBtn').style.display = 'none';
            
            // Réafficher le bouton menu sur mobile
            const menuToggle = document.getElementById('menuToggle');
            if (menuToggle) menuToggle.style.display = '';
            
            // Réinitialiser le mode édition
            editModeActive = false;
        }

        // Fermer la modal avec la touche Échap
        document.addEventListener('keydown', (e) => {
            if (e.key === 'Escape') {
                const stepMode = document.getElementById('stepByStepMode');
                const stepDrawer = document.getElementById('stepIngredientsDrawer');
                
                // Si le drawer du mode étape par étape est ouvert, le fermer
                if (stepDrawer.classList.contains('open')) {
                    closeStepIngredientsDrawer();
                }
                // Sinon, si le mode étape par étape est actif, le fermer
                else if (stepMode.classList.contains('active')) {
                    closeStepByStep();
                } 
                // Sinon, fermer la modal normale
                else {
                    closeRecipeModal();
                }
            }
        });

        // ============================================
        // FONCTIONS MODE ÉTAPE PAR ÉTAPE
        // ============================================

        function startStepByStep() {
            if (!currentRecipeForStepMode) return;
            
            // Fermer la modal normale
            closeRecipeModal();
            
            // Préparer les données
            stepByStepData.recipe = currentRecipeForStepMode;
            stepByStepData.steps = parseStepsFromRecipe(currentRecipeForStepMode);
            stepByStepData.currentStepIndex = 0;
            
            // Préparer le drawer avec tous les ingrédients
            prepareStepIngredientsDrawer(currentRecipeForStepMode);
            
            // Afficher le mode
            document.getElementById('stepByStepMode').classList.add('active');
            document.getElementById('stepHeaderTitle').textContent = currentRecipeForStepMode.nom || 'Recette';
            document.body.style.overflow = 'hidden';
            
            // Afficher la première étape
            displayCurrentStep();
        }

        function prepareStepIngredientsDrawer(recipe) {
            const drawerContent = document.getElementById('stepDrawerContent');
            const ingredientsBtn = document.getElementById('stepAllIngredientsBtn');
            
            // Vérifier s'il y a des ingrédients
            if (!recipe.ingredientsSections && !recipe.ingredients) {
                ingredientsBtn.style.display = 'none';
                return;
            }
            
            let html = '';
            
            // Si on a des sections d'ingrédients avec quantités ajustées
            if (recipe.ingredientsSections && recipe.ingredientsSections.length > 0) {
                recipe.ingredientsSections.forEach((section, index) => {
                    const adjustedContent = getAdjustedIngredientsContent(`ingredients-section-${index}`);
                    html += `
                        <div class="step-drawer-section">
                            <div class="step-drawer-section-title">${section.title}</div>
                            <div class="step-drawer-section-content">${adjustedContent || section.content}</div>
                        </div>
                    `;
                });
            } 
            // Sinon, utiliser les ingrédients simples avec quantités ajustées
            else if (recipe.ingredients) {
                const adjustedContent = getAdjustedIngredientsContent('ingredients-simple');
                html += `
                    <div class="step-drawer-section">
                        <div class="step-drawer-section-title">Ingrédients</div>
                        <div class="step-drawer-section-content">${adjustedContent || recipe.ingredients}</div>
                    </div>
                `;
            }
            
            drawerContent.innerHTML = html;
            ingredientsBtn.style.display = 'flex';
        }

        function openStepIngredientsDrawer() {
            document.getElementById('stepIngredientsDrawer').classList.add('open');
            document.getElementById('stepDrawerOverlay').classList.add('show');
        }

        function closeStepIngredientsDrawer() {
            document.getElementById('stepIngredientsDrawer').classList.remove('open');
            document.getElementById('stepDrawerOverlay').classList.remove('show');
        }

        function parseStepsFromRecipe(recipe) {
            let steps = [];
            
            // Si la recette a des sections de préparation
            if (recipe.preparationSections && recipe.preparationSections.length > 0) {
                recipe.preparationSections.forEach(section => {
                    // Trouver les ingrédients correspondants avec quantités ajustées
                    let sectionIngredients = null;
                    let ingredientSectionId = null;
                    
                    if (recipe.ingredientsSections) {
                        const foundIndex = recipe.ingredientsSections.findIndex(
                            ing => ing.title.toLowerCase() === section.title.toLowerCase()
                        );
                        
                        if (foundIndex !== -1) {
                            ingredientSectionId = `ingredients-section-${foundIndex}`;
                            // Récupérer le contenu ajusté depuis le DOM
                            const adjustedContent = getAdjustedIngredientsContent(ingredientSectionId);
                            sectionIngredients = adjustedContent || recipe.ingredientsSections[foundIndex].content;
                        }
                    }
                    
                    // Séparer les étapes (par numéro ou tiret)
                    const stepLines = section.content.split('\n').filter(line => line.trim());
                    stepLines.forEach(line => {
                        const cleaned = line.replace(/^\d+\.\s*/, '').replace(/^-\s*/, '').trim();
                        if (cleaned) {
                            steps.push({
                                sectionTitle: section.title,
                                text: cleaned,
                                ingredients: sectionIngredients
                            });
                        }
                    });
                });
            } 
            // Sinon, utiliser la préparation simple
            else if (recipe.preparation) {
                const stepLines = recipe.preparation.split('\n').filter(line => line.trim());
                // Récupérer les ingrédients ajustés
                const adjustedIngredients = getAdjustedIngredientsContent('ingredients-simple');
                const ingredientsToUse = adjustedIngredients || recipe.ingredients || null;
                
                stepLines.forEach(line => {
                    const cleaned = line.replace(/^\d+\.\s*/, '').replace(/^-\s*/, '').trim();
                    if (cleaned) {
                        steps.push({
                            sectionTitle: 'Préparation',
                            text: cleaned,
                            ingredients: ingredientsToUse
                        });
                    }
                });
            }
            
            return steps;
        }

        function displayCurrentStep() {
            const step = stepByStepData.steps[stepByStepData.currentStepIndex];
            const totalSteps = stepByStepData.steps.length;
            const currentIndex = stepByStepData.currentStepIndex + 1;
            
            // Mise à jour du compteur et de la barre de progression
            document.getElementById('stepCounter').textContent = `Étape ${currentIndex}/${totalSteps}`;
            const progressPercent = (currentIndex / totalSteps) * 100;
            document.getElementById('stepProgressFill').style.width = progressPercent + '%';
            
            // Mise à jour du contenu
            document.getElementById('stepSectionTitle').textContent = step.sectionTitle;
            document.getElementById('stepText').textContent = step.text;
            
            // Afficher les ingrédients si disponibles
            const ingredientsBox = document.getElementById('stepIngredientsBox');
            if (step.ingredients) {
                document.getElementById('stepIngredientsList').textContent = step.ingredients;
                ingredientsBox.style.display = 'block';
            } else {
                ingredientsBox.style.display = 'none';
            }
            
            // Mise à jour des boutons de navigation
            document.getElementById('stepPrevBtn').disabled = currentIndex === 1;
            
            const nextBtn = document.getElementById('stepNextBtn');
            if (currentIndex === totalSteps) {
                nextBtn.textContent = '✓ Terminer';
                nextBtn.classList.remove('step-next-btn');
                nextBtn.classList.add('step-finish-btn');
            } else {
                nextBtn.textContent = 'Suivant →';
                nextBtn.classList.remove('step-finish-btn');
                nextBtn.classList.add('step-next-btn');
            }
            nextBtn.disabled = false;
        }

        function previousStep() {
            if (stepByStepData.currentStepIndex > 0) {
                stepByStepData.currentStepIndex--;
                displayCurrentStep();
            }
        }

        function nextStep() {
            if (stepByStepData.currentStepIndex < stepByStepData.steps.length - 1) {
                stepByStepData.currentStepIndex++;
                displayCurrentStep();
            } else {
                // Dernière étape : fermer le mode
                closeStepByStep();
            }
        }

        function backToRecipe() {
            // Sauvegarder la recette avant de fermer
            const recipe = currentRecipeForStepMode;
            
            // Fermer le mode étape par étape
            closeStepByStep();
            
            // Rouvrir la modal de la recette
            if (recipe) {
                openRecipeModal(recipe);
            }
        }

        function closeStepByStep() {
            // Fermer le drawer s'il est ouvert
            closeStepIngredientsDrawer();
            
            // Cacher le bouton des ingrédients
            document.getElementById('stepAllIngredientsBtn').style.display = 'none';
            
            // Fermer le mode
            document.getElementById('stepByStepMode').classList.remove('active');
            document.body.style.overflow = 'auto';
            stepByStepData = {
                recipe: null,
                steps: [],
                currentStepIndex: 0
            };
        }

        // ============================================
        // FONCTIONS D'IMPORT CSV
        // ============================================

        function openImportModal() {
            document.getElementById('importModal').classList.add('active');
            document.getElementById('csvTextarea').value = '';
            document.getElementById('importStatus').className = 'import-status';
            document.getElementById('importStatus').textContent = '';
            document.body.style.overflow = 'hidden';
        }

        function closeImportModal() {
            document.getElementById('importModal').classList.remove('active');
            document.body.style.overflow = 'auto';
        }

        async function importRecipeFromCSV() {
            const csvData = document.getElementById('csvTextarea').value.trim();
            const statusDiv = document.getElementById('importStatus');
            
            if (!csvData) {
                statusDiv.className = 'import-status error';
                statusDiv.textContent = '❌ Veuillez coller le CSV avant d\'importer.';
                return;
            }

            // Afficher le statut de chargement
            statusDiv.className = 'import-status loading';
            statusDiv.textContent = '⏳ Import en cours...';

            try {
                const response = await fetch(webAppUrl, {
                    method: 'POST',
                    mode: 'no-cors',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        action: 'importRecipe',
                        csvData: csvData
                    })
                });

                // Avec mode no-cors, on ne peut pas lire la réponse
                // On considère que c'est un succès si pas d'erreur
                statusDiv.className = 'import-status success';
                statusDiv.textContent = `✅ Recette envoyée ! Rechargement...`;
                
                // Recharger les recettes après 2 secondes
                setTimeout(() => {
                    loadRecipes();
                    closeImportModal();
                }, 2000);
                
            } catch (error) {
                statusDiv.className = 'import-status error';
                statusDiv.textContent = `❌ Erreur : ${error.message}. Vérifiez que votre Web App est bien déployé.`;
                console.error('Détails de l\'erreur:', error);
            }
        }

        // Fermer la modal d'import avec la touche Échap
        document.addEventListener('keydown', (e) => {
            if (e.key === 'Escape') {
                const importModal = document.getElementById('importModal');
                if (importModal.classList.contains('active')) {
                    closeImportModal();
                    return;
                }
            }
        });

        function filterRecipes() {
            const searchTerm = document.getElementById('searchInput').value.toLowerCase();
            
            let recipesToFilter = activeCategory === 'all' ? allRecipes : filteredRecipes;

            if (searchTerm === '') {
                displayRecipes(recipesToFilter);
                return;
            }

            const filtered = recipesToFilter.filter(recipe => {
                return (
                    (recipe.nom && recipe.nom.toLowerCase().includes(searchTerm)) ||
                    (recipe.categorie && recipe.categorie.toLowerCase().includes(searchTerm)) ||
                    (recipe.ingredients && recipe.ingredients.toLowerCase().includes(searchTerm)) ||
                    (recipe.preparation && recipe.preparation.toLowerCase().includes(searchTerm)) ||
                    (recipe.difficulte && recipe.difficulte.toLowerCase().includes(searchTerm))
                );
            });

            if (filtered.length === 0) {
                document.getElementById('recipesGrid').innerHTML = '<div class="no-results">Aucune recette ne correspond à votre recherche</div>';
            } else {
                displayRecipes(filtered);
            }
        }

        // ===== Fonctions d'ajustement de portions =====
        let originalPortionData = {
            portions: 0,
            ingredients: [],
            allQuantities: [] // Stocke toutes les quantités originales avec leur position
        };

        let globalRatio = 1.0; // Ratio global appliqué à toutes les quantités
        let editModeActive = false; // Mode édition des quantités activé ou non

        function extractPortionNumber(portionStr) {
            if (!portionStr) return null;
            const match = portionStr.match(/(\d+)/);
            return match ? parseInt(match[1]) : null;
        }

        function adjustPortion(delta) {
            const currentEl = document.getElementById('currentPortions');
            if (!currentEl) return;

            let current = parseInt(currentEl.textContent);
            let newValue = current + delta;

            // Minimum 1 portion
            if (newValue < 1) newValue = 1;

            // Calculer le nouveau ratio global
            globalRatio = newValue / originalPortionData.portions;

            // Mettre à jour toutes les quantités
            updateAllQuantities();
            
            // Mettre à jour l'affichage des portions
            currentEl.textContent = newValue;
        }

        function resetPortions() {
            const currentEl = document.getElementById('currentPortions');
            if (!currentEl) return;

            // Réinitialiser le ratio global
            globalRatio = 1.0;

            // Mettre à jour toutes les quantités
            updateAllQuantities();

            // Réinitialiser l'affichage des portions
            currentEl.textContent = originalPortionData.portions;

            // Supprimer tous les indicateurs de modification
            document.querySelectorAll('.ingredient-modified-indicator').forEach(el => el.remove());
        }

        function adjustQuantitiesInText(text, ratio) {
            let adjustedText = text;

            // Traiter les fractions d'abord
            adjustedText = adjustedText.replace(/(\d+)\/(\d+)/g, (match, numerator, denominator) => {
                const originalValue = parseInt(numerator) / parseInt(denominator);
                const newValue = originalValue * ratio;
                // Essayer de garder une représentation fractionnaire
                return formatNumberOrFraction(newValue);
            });

            // Traiter les nombres avec unités
            adjustedText = adjustedText.replace(/(\d+(?:[.,]\d+)?)\s*(g|kg|ml|l|cl|dl|c\.|cuillères?|càs|càc|tasses?|pincées?|sachets?|pot|pots)?/gi, 
                (match, number, unit) => {
                    const originalValue = parseFloat(number.replace(',', '.'));
                    const newValue = originalValue * ratio;
                    const formattedNumber = formatNumber(newValue);
                    
                    // Mettre en évidence les quantités ajustées
                    const highlighted = `<span class="ingredient-adjusted">${formattedNumber}</span>`;
                    return unit ? `${highlighted} ${unit}` : highlighted;
                }
            );

            return adjustedText;
        }

        function formatNumber(num) {
            // Arrondir intelligemment
            if (num < 1) {
                // Pour les petites quantités, garder 2 décimales
                return num.toFixed(2).replace(/\.?0+$/, '');
            } else if (num < 10) {
                // Pour les quantités moyennes, 1 décimale
                return num.toFixed(1).replace(/\.?0+$/, '');
            } else {
                // Pour les grandes quantités, arrondir à l'entier
                return Math.round(num).toString();
            }
        }

        function formatNumberOrFraction(num) {
            // Essayer de trouver une fraction simple pour les petits nombres
            const commonFractions = [
                { value: 1/4, display: '1/4' },
                { value: 1/3, display: '1/3' },
                { value: 1/2, display: '1/2' },
                { value: 2/3, display: '2/3' },
                { value: 3/4, display: '3/4' },
                { value: 1, display: '1' },
                { value: 1.25, display: '1 1/4' },
                { value: 1.33, display: '1 1/3' },
                { value: 1.5, display: '1 1/2' },
                { value: 1.67, display: '1 2/3' },
                { value: 1.75, display: '1 3/4' },
                { value: 2, display: '2' },
                { value: 2.5, display: '2 1/2' },
                { value: 3, display: '3' },
                { value: 3.5, display: '3 1/2' }
            ];

            // Chercher une fraction proche (tolérance de 0.05)
            for (let frac of commonFractions) {
                if (Math.abs(num - frac.value) < 0.05) {
                    return frac.display;
                }
            }

            // Sinon, utiliser le formatage normal
            return formatNumber(num);
        }

        function storeOriginalPortionData(recipe) {
            const portions = extractPortionNumber(recipe.portions);
            if (!portions) return;

            originalPortionData.portions = portions;
            originalPortionData.ingredients = [];
            originalPortionData.allQuantities = [];
            globalRatio = 1.0;
            editModeActive = false; // Réinitialiser le mode édition

            // Stocker les ingrédients sectionnés
            if (recipe.ingredientsSections && recipe.ingredientsSections.length > 0) {
                recipe.ingredientsSections.forEach((section, index) => {
                    originalPortionData.ingredients.push({
                        id: `ingredients-section-${index}`,
                        content: section.content
                    });
                });
            } else if (recipe.ingredients) {
                // Stocker les ingrédients simples
                originalPortionData.ingredients.push({
                    id: 'ingredients-simple',
                    content: recipe.ingredients
                });
            }

            // Préparer les quantités (non éditables par défaut)
            setTimeout(() => makeQuantitiesEditable(), 100);
        }

        function makeQuantitiesEditable() {
            originalPortionData.allQuantities = [];
            let quantityIndex = 0;

            originalPortionData.ingredients.forEach(({ id }) => {
                const element = document.getElementById(id);
                if (!element) return;

                // Diviser le contenu en lignes
                const lines = element.innerHTML.split('<br>').filter(line => line.trim());
                
                let newHTML = lines.map((line) => {
                    // Traiter directement sans placeholders - une seule passe
                    let processedLine = line;
                    const replacements = [];
                    
                    // Trouver toutes les quantités (fractions ET nombres)
                    // Pattern combiné pour capturer tout
                    const pattern = /(\d+)\/(\d+)|(\d+(?:[.,]\d+)?)/g;
                    let match;
                    let lastIndex = 0;
                    let result = '';
                    
                    while ((match = pattern.exec(processedLine)) !== null) {
                        // Ajouter le texte avant le match
                        result += processedLine.substring(lastIndex, match.index);
                        
                        if (match[1] && match[2]) {
                            // C'est une fraction (groupe 1 et 2)
                            const numerator = parseInt(match[1]);
                            const denominator = parseInt(match[2]);
                            const originalValue = numerator / denominator;
                            const qId = `qty-${quantityIndex}`;
                            
                            originalPortionData.allQuantities.push({
                                id: qId,
                                value: originalValue,
                                unit: '',
                                isFraction: true,
                                numerator: numerator,
                                denominator: denominator
                            });
                            
                            quantityIndex++;
                            
                            result += `<span class="editable-quantity" id="${qId}" data-original="${originalValue}" data-unit="" data-fraction="${numerator}/${denominator}">${numerator}/${denominator}</span>`;
                        } else if (match[3]) {
                            // C'est un nombre décimal ou entier (groupe 3)
                            const number = match[3];
                            const originalValue = parseFloat(number.replace(',', '.'));
                            const qId = `qty-${quantityIndex}`;
                            
                            originalPortionData.allQuantities.push({
                                id: qId,
                                value: originalValue,
                                unit: '',
                                isFraction: false
                            });
                            
                            quantityIndex++;
                            
                            result += `<span class="editable-quantity" id="${qId}" data-original="${originalValue}" data-unit="">${number}</span>`;
                        }
                        
                        lastIndex = pattern.lastIndex;
                    }
                    
                    // Ajouter le reste du texte
                    result += processedLine.substring(lastIndex);
                    
                    return `<div class="ingredient-line">${result}</div>`;
                }).join('');

                element.innerHTML = newHTML;
            });
        }

        function togglePortionAdjuster() {
            const adjuster = document.getElementById('portionAdjuster');
            if (adjuster) {
                adjuster.classList.toggle('collapsed');
            }
        }

        function toggleEditMode() {
            editModeActive = !editModeActive;
            
            const adjuster = document.getElementById('portionAdjuster');
            const toggleBtn = document.getElementById('editModeToggle');
            const icon = document.getElementById('editModeIcon');
            const text = document.getElementById('editModeText');
            
            if (editModeActive) {
                // Activer le mode édition
                adjuster.classList.add('edit-mode-active');
                toggleBtn.classList.add('active');
                icon.textContent = '🔒';
                text.textContent = 'Verrouiller les quantités';
                
                // Rendre les quantités éditables
                originalPortionData.allQuantities.forEach(qty => {
                    const el = document.getElementById(qty.id);
                    if (el) {
                        el.contentEditable = 'true';
                        el.onblur = () => handleQuantityChange(qty.id);
                        el.onkeydown = (e) => handleQuantityKeydown(e, qty.id);
                    }
                });
            } else {
                // Désactiver le mode édition
                adjuster.classList.remove('edit-mode-active');
                toggleBtn.classList.remove('active');
                icon.textContent = '✏️';
                text.textContent = 'Modifier les quantités';
                
                // Rendre les quantités non éditables
                originalPortionData.allQuantities.forEach(qty => {
                    const el = document.getElementById(qty.id);
                    if (el) {
                        el.contentEditable = 'false';
                        el.onblur = null;
                        el.onkeydown = null;
                    }
                });
            }
        }

        function handleQuantityKeydown(event, qId) {
            if (event.key === 'Enter') {
                event.preventDefault();
                event.target.blur(); // Déclenche onblur
            }
            if (event.key === 'Escape') {
                event.preventDefault();
                // Restaurer la valeur originale
                const el = document.getElementById(qId);
                if (el) {
                    const originalValue = parseFloat(el.dataset.original);
                    const adjustedValue = originalValue * globalRatio;
                    el.textContent = formatNumber(adjustedValue);
                    el.blur();
                }
            }
        }

        function handleQuantityChange(qId) {
            const el = document.getElementById(qId);
            if (!el) return;

            let newText = el.textContent.trim().replace(',', '.');
            let newValue;
            
            // Essayer de parser comme fraction (ex: "1/2", "3/4")
            const fractionMatch = newText.match(/^(\d+)\/(\d+)$/);
            if (fractionMatch) {
                const numerator = parseInt(fractionMatch[1]);
                const denominator = parseInt(fractionMatch[2]);
                newValue = numerator / denominator;
            } 
            // Essayer de parser comme fraction mixte (ex: "1 1/2", "2 3/4")
            else {
                const mixedMatch = newText.match(/^(\d+)\s+(\d+)\/(\d+)$/);
                if (mixedMatch) {
                    const whole = parseInt(mixedMatch[1]);
                    const numerator = parseInt(mixedMatch[2]);
                    const denominator = parseInt(mixedMatch[3]);
                    newValue = whole + (numerator / denominator);
                } else {
                    // Parser comme nombre décimal
                    newValue = parseFloat(newText);
                }
            }
            
            // Validation
            if (isNaN(newValue) || newValue <= 0) {
                // Restaurer la valeur précédente
                const qty = originalPortionData.allQuantities.find(q => q.id === qId);
                if (qty) {
                    const adjustedValue = qty.value * globalRatio;
                    if (qty.isFraction && Math.abs(globalRatio - 1.0) < 0.01) {
                        el.textContent = `${qty.numerator}/${qty.denominator}`;
                    } else {
                        el.textContent = formatNumber(adjustedValue);
                    }
                }
                return;
            }

            // Trouver la quantité originale
            const qty = originalPortionData.allQuantities.find(q => q.id === qId);
            if (!qty) return;

            // Calculer le nouveau ratio global basé sur ce changement
            const newRatio = newValue / qty.value;

            // Si le ratio a changé significativement
            if (Math.abs(newRatio - globalRatio) > 0.01) {
                globalRatio = newRatio;
                
                // Appliquer le nouveau ratio à TOUTES les quantités
                updateAllQuantities();
                
                // Mettre à jour le nombre de portions
                updatePortionDisplay();
            }
        }

        function updateAllQuantities() {
            originalPortionData.allQuantities.forEach(qty => {
                const el = document.getElementById(qty.id);
                if (!el) return;

                const newValue = qty.value * globalRatio;
                
                // Si c'est une fraction et que le ratio est proche de 1, garder la fraction originale
                if (qty.isFraction && Math.abs(globalRatio - 1.0) < 0.01) {
                    el.textContent = `${qty.numerator}/${qty.denominator}`;
                } else if (qty.isFraction) {
                    // Pour les fractions ajustées, afficher en décimal ou essayer de trouver une fraction simple
                    el.textContent = formatNumberOrFraction(newValue);
                } else {
                    el.textContent = formatNumber(newValue);
                }
                
                // Ajouter un indicateur si modifié
                if (Math.abs(globalRatio - 1.0) > 0.01) {
                    if (!el.nextElementSibling || !el.nextElementSibling.classList.contains('ingredient-modified-indicator')) {
                        const indicator = document.createElement('span');
                        indicator.className = 'ingredient-modified-indicator';
                        indicator.title = `×${globalRatio.toFixed(2)}`;
                        el.parentNode.insertBefore(indicator, el.nextSibling);
                    }
                } else {
                    const indicator = el.nextElementSibling;
                    if (indicator && indicator.classList.contains('ingredient-modified-indicator')) {
                        indicator.remove();
                    }
                }
            });

            // Mettre à jour les drawers et le mode étape par étape avec les nouvelles quantités
            if (currentRecipeForStepMode) {
                prepareIngredientsDrawer(currentRecipeForStepMode);
                prepareStepIngredientsDrawer(currentRecipeForStepMode);
                
                // Rafraîchir l'étape courante dans le mode étape par étape si actif
                if (stepByStepData.recipe) {
                    stepByStepData.steps = parseStepsFromRecipe(currentRecipeForStepMode);
                    if (document.getElementById('stepByStepMode').classList.contains('active')) {
                        displayCurrentStep();
                    }
                }
            }
        }

        function updatePortionDisplay() {
            const currentEl = document.getElementById('currentPortions');
            if (!currentEl) return;

            const newPortions = Math.round(originalPortionData.portions * globalRatio);
            currentEl.textContent = newPortions;
        }

        // ============================================
        // FONCTIONS LISTE DE COURSES - STOCKAGE
        // ============================================

        async function saveShoppingListToStorage() {
            try {
                // Utiliser no-cors comme pour importRecipe (Google Apps Script a des limitations CORS)
                await fetch(webAppUrl, {
                    method: 'POST',
                    mode: 'no-cors',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        action: 'saveShoppingList',
                        shoppingList: shoppingList
                    })
                });
                
                // Avec mode no-cors, on ne peut pas lire la réponse
                // On considère que c'est un succès si pas d'erreur
            } catch (e) {
                console.error('Erreur lors de la sauvegarde de la liste de courses:', e);
                alert('Erreur lors de la sauvegarde de la liste de courses. Vérifiez votre connexion et que votre Web App est bien configurée.\n\nDétails: ' + e.message);
            }
        }

        async function loadShoppingListFromStorage() {
            try {
                // Utiliser GET avec un paramètre pour éviter les problèmes CORS
                const response = await fetch(webAppUrl + '?action=loadShoppingList');
                
                if (!response.ok) {
                    throw new Error(`Erreur HTTP: ${response.status} ${response.statusText}`);
                }
                
                const data = await response.json();
                
                if (data.success && data.shoppingList) {
                    shoppingList = data.shoppingList;
                    // S'assurer que flatOrder existe
                    if (!shoppingList.flatOrder) {
                        shoppingList.flatOrder = [];
                    }
                    updateShoppingListBadge();
                } else if (data.shoppingList) {
                    // Si pas de success mais shoppingList existe
                    shoppingList = data.shoppingList;
                    if (!shoppingList.flatOrder) {
                        shoppingList.flatOrder = [];
                    }
                    updateShoppingListBadge();
                } else {
                    // Si pas de données, initialiser une liste vide
                    shoppingList = { recipes: [], flatOrder: [] };
                    updateShoppingListBadge();
                }
                
                if (data.warning) {
                    console.warn('Avertissement:', data.warning);
                }
            } catch (e) {
                console.error('Erreur lors du chargement de la liste de courses:', e);
                // En cas d'erreur, initialiser une liste vide
                shoppingList = { recipes: [], flatOrder: [] };
                updateShoppingListBadge();
            }
        }

        function updateShoppingListBadge() {
            const badge = document.getElementById('shoppingListBadge');
            if (badge) {
                // Compter seulement les recettes avec ingrédients
                const count = shoppingList.recipes.filter(r => r.ingredients.length > 0).length;
                badge.textContent = count;
                badge.style.display = count > 0 ? 'inline-block' : 'none';
            }
        }

        function detectIngredientCategory(ingredientText) {
            const text = ingredientText.toLowerCase();
            
            // Fruits et légumes
            if (/tomate|salade|laitue|carotte|oignon|poivron|courgette|aubergine|pomme|poire|banane|orange|citron|légume|fruit|épinard|brocoli|chou|concombre|radis|céleri/i.test(text)) {
                return "Fruits & Légumes";
            }
            
            // Viandes et poissons
            if (/viande|poulet|bœuf|porc|agneau|veau|canard|dinde|poisson|saumon|thon|cabillaud|crevette|moule|œuf|jambon|bacon|saucisse/i.test(text)) {
                return "Viandes & Poissons";
            }
            
            // Produits laitiers
            if (/lait|crème|beurre|fromage|yaourt|yogourt|mozzarella|parmesan|gruyère|emmental|ricotta/i.test(text)) {
                return "Produits laitiers";
            }
            
            // Épices et condiments
            if (/sel|poivre|épice|curry|paprika|cumin|cannelle|vanille|muscade|basilic|thym|romarin|persil|coriandre|origan|laurier|moutarde|vinaigre|sauce|ketchup|mayonnaise/i.test(text)) {
                return "Épices & Condiments";
            }
            
            // Épicerie (pâtes, riz, farine, etc.)
            if (/farine|sucre|riz|pâte|pain|céréale|quinoa|semoule|couscous|levure|huile|chocolat|cacao|confiture|miel|biscuit|pâtisserie/i.test(text)) {
                return "Épicerie";
            }
            
            // Autres
            return "Autres";
        }

        // ============================================
        // FONCTIONS LISTE DE COURSES - GESTION
        // ============================================

        function openShoppingList() {
            document.getElementById('shoppingListMode').classList.add('active');
            document.body.style.overflow = 'hidden';
            renderShoppingList();
            closeSidebar();
        }

        function closeShoppingList() {
            document.getElementById('shoppingListMode').classList.remove('active');
            document.body.style.overflow = 'auto';
        }

        function toggleShoppingView() {
            shoppingListViewMode = shoppingListViewMode === 'recipe' ? 'flat' : 'recipe';
            const viewText = document.getElementById('shoppingViewText');
            viewText.textContent = shoppingListViewMode === 'recipe' ? '🔀 Vue personnalisée' : '📝 Vue par recettes';
            renderShoppingList();
        }

        function addRecipeToShoppingListFromModal() {
            const recipe = currentRecipeForStepMode;
            if (!recipe) return;

            addRecipeToShoppingList(recipe);
        }

        function addRecipeToShoppingList(recipe) {
            // Vérifier si déjà dans la liste
            if (shoppingList.recipes.find(r => r.name === recipe.nom)) {
                alert('Cette recette est déjà dans votre liste de courses !');
                return;
            }

            // Extraire les ingrédients avec quantités ajustées
            const ingredients = [];
            let ingredientId = 0;

            if (recipe.ingredientsSections && recipe.ingredientsSections.length > 0) {
                recipe.ingredientsSections.forEach((section, sectionIndex) => {
                    const adjustedContent = getAdjustedIngredientsContent(`ingredients-section-${sectionIndex}`);
                    const content = adjustedContent || section.content;
                    
                    // Séparer par lignes et traiter chaque ingrédient
                    const lines = content.split(/<br>|\n/).filter(line => line.trim());
                    lines.forEach(line => {
                        const cleanLine = line.replace(/<[^>]*>/g, '').trim();
                        if (cleanLine && cleanLine !== '-') {
                            ingredients.push({
                                id: `ing-${ingredientId++}`,
                                text: cleanLine,
                                originalText: cleanLine,
                                checked: false,
                                category: detectIngredientCategory(cleanLine)
                            });
                        }
                    });
                });
            } else if (recipe.ingredients) {
                const adjustedContent = getAdjustedIngredientsContent('ingredients-simple');
                const content = adjustedContent || recipe.ingredients;
                
                const lines = content.split(/<br>|\n/).filter(line => line.trim());
                lines.forEach(line => {
                    const cleanLine = line.replace(/<[^>]*>/g, '').trim();
                    if (cleanLine && cleanLine !== '-') {
                        ingredients.push({
                            id: `ing-${ingredientId++}`,
                            text: cleanLine,
                            originalText: cleanLine,
                            checked: false,
                            category: detectIngredientCategory(cleanLine)
                        });
                    }
                });
            }

            // Ajouter à la liste
            const newRecipe = {
                id: `recipe-${Date.now()}`,
                name: recipe.nom,
                portions: extractPortionNumber(recipe.portions) || 0,
                adjustedPortions: Math.round((extractPortionNumber(recipe.portions) || 0) * globalRatio),
                ingredients: ingredients
            };

            shoppingList.recipes.push(newRecipe);
            
            // Ajouter tous les nouveaux ingrédients à flatOrder (à la fin)
            if (!shoppingList.flatOrder) {
                shoppingList.flatOrder = [];
            }
            ingredients.forEach(ingredient => {
                shoppingList.flatOrder.push({
                    recipeId: newRecipe.id,
                    ingredientId: ingredient.id
                });
            });
            
            saveShoppingListToStorage();
            updateShoppingListBadge();

            // Fermer la modal de recette et ouvrir la liste
            closeRecipeModal();
            openShoppingList();
        }

        function removeRecipeFromShoppingList(recipeId) {
            if (confirm('Voulez-vous vraiment supprimer cette recette de votre liste de courses ?')) {
                shoppingList.recipes = shoppingList.recipes.filter(r => r.id !== recipeId);
                
                // Retirer les ingrédients de cette recette de flatOrder
                if (shoppingList.flatOrder) {
                    shoppingList.flatOrder = shoppingList.flatOrder.filter(item => item.recipeId !== recipeId);
                }
                
                saveShoppingListToStorage();
                updateShoppingListBadge();
                renderShoppingList();
            }
        }

        function toggleIngredientChecked(recipeId, ingredientId) {
            const recipe = shoppingList.recipes.find(r => r.id === recipeId);
            if (!recipe) return;

            const ingredient = recipe.ingredients.find(i => i.id === ingredientId);
            if (!ingredient) return;

            ingredient.checked = !ingredient.checked;
            saveShoppingListToStorage();
            renderShoppingList();
        }

        function clearShoppingList() {
            if (confirm('Voulez-vous vraiment vider toute votre liste de courses ?')) {
                // Conserver "Autres Achats" mais vider tous les ingrédients
                const customRecipe = shoppingList.recipes.find(r => r.id === 'custom-items');
                if (customRecipe) {
                    shoppingList = { 
                        recipes: [{
                            id: 'custom-items',
                            name: 'Autres achats',
                            isCustom: true,
                            ingredients: []
                        }], 
                        flatOrder: [] 
                    };
                } else {
                    shoppingList = { recipes: [], flatOrder: [] };
                }
                saveShoppingListToStorage();
                updateShoppingListBadge();
                renderShoppingList();
            }
        }

        function getOrCreateCustomRecipe() {
            let customRecipe = shoppingList.recipes.find(r => r.id === 'custom-items');
            
            if (!customRecipe) {
                customRecipe = {
                    id: 'custom-items',
                    name: 'Autres achats',
                    isCustom: true,
                    portions: 0,
                    adjustedPortions: 0,
                    ingredients: []
                };
                shoppingList.recipes.push(customRecipe);
            }
            
            return customRecipe;
        }

        function addCustomIngredient() {
            const input = document.getElementById('customIngredientInput');
            const text = input.value.trim();
            
            if (!text) return;
            
            // Obtenir ou créer la recette "Autres achats"
            const customRecipe = getOrCreateCustomRecipe();
            
            // Ajouter l'ingrédient
            const newIngredient = {
                id: `custom-ing-${Date.now()}`,
                text: text,
                originalText: text,
                checked: false,
                category: detectIngredientCategory(text)
            };
            
            customRecipe.ingredients.push(newIngredient);
            
            // Ajouter à flatOrder (à la fin)
            if (!shoppingList.flatOrder) {
                shoppingList.flatOrder = [];
            }
            shoppingList.flatOrder.push({
                recipeId: customRecipe.id,
                ingredientId: newIngredient.id
            });
            
            // Sauvegarder et rafraîchir
            saveShoppingListToStorage();
            updateShoppingListBadge();
            renderShoppingList();
            
            // Vider l'input et remettre le focus
            input.value = '';
            input.focus();
        }

        function clearCheckedCustomItems() {
            const customRecipe = shoppingList.recipes.find(r => r.id === 'custom-items');
            
            if (!customRecipe) return;
            
            // Récupérer les IDs des ingrédients cochés avant de les supprimer
            const checkedIngredientIds = customRecipe.ingredients
                .filter(ing => ing.checked)
                .map(ing => ing.id);
            
            // Garder uniquement les ingrédients non cochés
            customRecipe.ingredients = customRecipe.ingredients.filter(ing => !ing.checked);
            
            // Retirer ces ingrédients de flatOrder
            if (shoppingList.flatOrder && checkedIngredientIds.length > 0) {
                shoppingList.flatOrder = shoppingList.flatOrder.filter(item => 
                    !(item.recipeId === 'custom-items' && checkedIngredientIds.includes(item.ingredientId))
                );
            }
            
            // Note: On garde la recette même si elle est vide pour qu'elle reste visible
            
            // Sauvegarder et rafraîchir
            saveShoppingListToStorage();
            updateShoppingListBadge();
            renderShoppingList();
        }

        function renderShoppingList() {
            const content = document.getElementById('shoppingContent');

            if (shoppingList.recipes.length === 0) {
                content.innerHTML = `
                    <div class="shopping-empty">
                        <div class="shopping-empty-icon">🛒</div>
                        <div class="shopping-empty-text">Votre liste de courses est vide</div>
                        <div class="shopping-empty-hint">Ajoutez des recettes pour commencer</div>
                    </div>
                `;
                return;
            }

            if (shoppingListViewMode === 'recipe') {
                renderShoppingListByRecipe(content);
            } else if (shoppingListViewMode === 'flat') {
                renderShoppingListFlat(content);
            }
        }

        function renderShoppingListByRecipe(content) {
            // S'assurer que "Autres achats" existe
            let customRecipe = shoppingList.recipes.find(r => r.id === 'custom-items');
            if (!customRecipe) {
                customRecipe = {
                    id: 'custom-items',
                    name: 'Autres achats',
                    isCustom: true,
                    ingredients: []
                };
                shoppingList.recipes.push(customRecipe);
                saveShoppingListToStorage();
            }

            // Séparer les ingrédients cochés et non cochés
            const toBuy = [];
            const owned = [];

            shoppingList.recipes.forEach(recipe => {
                const toBuyIngredients = recipe.ingredients.filter(i => !i.checked);
                const ownedIngredients = recipe.ingredients.filter(i => i.checked);

                // Pour "Autres achats", TOUJOURS l'ajouter dans "À acheter" (pour garder le formulaire accessible)
                if (recipe.isCustom) {
                    toBuy.push({ recipe, ingredients: toBuyIngredients });
                    // Les articles cochés peuvent aussi apparaître dans "Déjà en possession"
                    if (ownedIngredients.length > 0) {
                        owned.push({ recipe, ingredients: ownedIngredients });
                    }
                } else {
                    // Pour les autres recettes, comportement normal
                    if (toBuyIngredients.length > 0) {
                        toBuy.push({ recipe, ingredients: toBuyIngredients });
                    }
                    if (ownedIngredients.length > 0) {
                        owned.push({ recipe, ingredients: ownedIngredients });
                    }
                }
            });

            let html = '';

            // Section "À acheter"
            if (toBuy.length > 0) {
                const totalIngredients = toBuy.reduce((sum, item) => sum + item.ingredients.length, 0);
                html += `
                    <div class="shopping-section">
                        <div class="shopping-section-title">
                            🛒 À acheter
                            <span class="shopping-section-count">${totalIngredients}</span>
                        </div>
                `;

                toBuy.forEach(({ recipe, ingredients }) => {
                    const deleteButton = recipe.isCustom 
                        ? `<button class="shopping-recipe-delete" onclick="clearCheckedCustomItems()">🗑️ Vider cochés</button>`
                        : `<button class="shopping-recipe-delete" onclick="removeRecipeFromShoppingList('${recipe.id}')">🗑️ Supprimer</button>`;
                    
                    const portionInfo = recipe.isCustom 
                        ? '' 
                        : `<div class="shopping-recipe-portions">${recipe.adjustedPortions || recipe.portions} personne(s)</div>`;
                    
                    html += `
                        <div class="shopping-recipe-group">
                            <div class="shopping-recipe-header">
                                <div>
                                    <div class="shopping-recipe-name">${recipe.name}</div>
                                    ${portionInfo}
                                </div>
                                ${deleteButton}
                            </div>
                    `;

                    // Afficher les ingrédients ou un message si vide (pour "Autres achats")
                    if (ingredients.length === 0 && recipe.isCustom) {
                        html += `
                            <div class="shopping-empty-custom">
                                Aucun article ajouté
                            </div>
                        `;
                    } else {
                        ingredients.forEach(ingredient => {
                            html += `
                                <div class="shopping-ingredient">
                                    <input type="checkbox" class="shopping-ingredient-checkbox" 
                                           onchange="toggleIngredientChecked('${recipe.id}', '${ingredient.id}')">
                                    <span class="shopping-ingredient-text">${ingredient.text}</span>
                                </div>
                            `;
                        });
                    }

                    // Ajouter le formulaire d'ajout pour "Autres achats"
                    if (recipe.isCustom) {
                        html += `
                            <div class="shopping-add-inline">
                                <div class="shopping-add-form">
                                    <input type="text" 
                                           id="customIngredientInput" 
                                           class="shopping-add-input"
                                           placeholder="Ex: Pain, savon, dentifrice..." 
                                           onkeypress="if(event.key==='Enter') addCustomIngredient()">
                                    <button class="shopping-add-btn" onclick="addCustomIngredient()">
                                        ➕ Ajouter
                                    </button>
                                </div>
                            </div>
                        `;
                    }

                    html += `</div>`;
                });

                html += `</div>`;
            }

            // Section "Déjà en possession"
            if (owned.length > 0) {
                const totalIngredients = owned.reduce((sum, item) => sum + item.ingredients.length, 0);
                html += `
                    <div class="shopping-section">
                        <div class="shopping-section-title">
                            ✓ Déjà en possession
                            <span class="shopping-section-count">${totalIngredients}</span>
                        </div>
                `;

                owned.forEach(({ recipe, ingredients }) => {
                    html += `
                        <div class="shopping-recipe-group">
                            <div class="shopping-recipe-header">
                                <div>
                                    <div class="shopping-recipe-name">${recipe.name}</div>
                                </div>
                            </div>
                    `;

                    ingredients.forEach(ingredient => {
                        html += `
                            <div class="shopping-ingredient checked">
                                <input type="checkbox" class="shopping-ingredient-checkbox" checked
                                       onchange="toggleIngredientChecked('${recipe.id}', '${ingredient.id}')">
                                <span class="shopping-ingredient-text">${ingredient.text}</span>
                            </div>
                        `;
                    });

                    html += `</div>`;
                });

                html += `</div>`;
            }

            // Bouton vider la liste
            html += `
                <div class="shopping-actions">
                    <button class="shopping-clear-btn" onclick="clearShoppingList()">
                        🗑️ Vider la liste
                    </button>
                </div>
            `;

            content.innerHTML = html;
        }

        function renderShoppingListFlat(content) {
            // Collecter tous les ingrédients de toutes les recettes
            let allIngredients = [];
            
            shoppingList.recipes.forEach(recipe => {
                recipe.ingredients.forEach(ingredient => {
                    allIngredients.push({
                        recipeId: recipe.id,
                        recipeName: recipe.name,
                        ingredient: ingredient,
                        isCustom: recipe.isCustom
                    });
                });
            });

            // Appliquer l'ordre personnalisé si disponible
            if (shoppingList.flatOrder && shoppingList.flatOrder.length > 0) {
                const orderMap = new Map();
                shoppingList.flatOrder.forEach((item, index) => {
                    orderMap.set(`${item.recipeId}-${item.ingredientId}`, index);
                });

                allIngredients.sort((a, b) => {
                    const keyA = `${a.recipeId}-${a.ingredient.id}`;
                    const keyB = `${b.recipeId}-${b.ingredient.id}`;
                    const indexA = orderMap.has(keyA) ? orderMap.get(keyA) : 9999;
                    const indexB = orderMap.has(keyB) ? orderMap.get(keyB) : 9999;
                    return indexA - indexB;
                });
            }

            // Séparer en "À acheter" et "Déjà en possession"
            const toBuy = allIngredients.filter(item => !item.ingredient.checked);
            const owned = allIngredients.filter(item => item.ingredient.checked);

            let html = '';

            // Section "À acheter"
            if (toBuy.length > 0) {
                html += `
                    <div class="shopping-section">
                        <div class="shopping-section-title">
                            🛒 À acheter
                            <span class="shopping-section-count">${toBuy.length}</span>
                        </div>
                `;

                toBuy.forEach(item => {
                    const recipeTag = item.isCustom ? '' : ` <span style="color: #999; font-size: 0.9em;">(${item.recipeName})</span>`;
                    html += `
                        <div class="shopping-ingredient" 
                             data-recipe-id="${item.recipeId}"
                             data-ingredient-id="${item.ingredient.id}">
                            <span class="drag-handle" 
                                  onmousedown="startDrag(event, '${item.recipeId}', '${item.ingredient.id}')"
                                  ontouchstart="startDrag(event, '${item.recipeId}', '${item.ingredient.id}')">
                                ⋮⋮
                            </span>
                            <input type="checkbox" class="shopping-ingredient-checkbox" 
                                   onchange="toggleIngredientChecked('${item.recipeId}', '${item.ingredient.id}')">
                            <span class="shopping-ingredient-text">${item.ingredient.text}${recipeTag}</span>
                        </div>
                    `;
                });

                html += `</div>`;
            }

            // Formulaire d'ajout d'articles (placé juste après "À acheter")
            html += `
                <div class="shopping-add-section" style="margin: 20px auto;">
                    <div class="shopping-add-form">
                        <input type="text" 
                               id="customIngredientInput" 
                               class="shopping-add-input"
                               placeholder="➕ Ajouter un article rapide..." 
                               onkeypress="if(event.key==='Enter') addCustomIngredient()">
                        <button class="shopping-add-btn" onclick="addCustomIngredient()">
                            Ajouter
                        </button>
                    </div>
                </div>
            `;

            // Section "Déjà en possession"
            if (owned.length > 0) {
                html += `
                    <div class="shopping-section">
                        <div class="shopping-section-title">
                            ✓ Déjà en possession
                            <span class="shopping-section-count">${owned.length}</span>
                        </div>
                `;

                owned.forEach(item => {
                    const recipeTag = item.isCustom ? '' : ` <span style="color: #999; font-size: 0.9em;">(${item.recipeName})</span>`;
                    html += `
                        <div class="shopping-ingredient checked">
                            <input type="checkbox" class="shopping-ingredient-checkbox" checked
                                   onchange="toggleIngredientChecked('${item.recipeId}', '${item.ingredient.id}')">
                            <span class="shopping-ingredient-text">${item.ingredient.text}${recipeTag}</span>
                        </div>
                    `;
                });

                html += `</div>`;
            }

            // Bouton vider la liste
            html += `
                <div class="shopping-actions">
                    <button class="shopping-clear-btn" onclick="clearShoppingList()">
                        🗑️ Vider la liste
                    </button>
                </div>
            `;

            content.innerHTML = html;
        }

        // Variables pour le drag & drop (nouveau système style Google Keep)
        function getEventCoordinates(event) {
            // Gérer à la fois mouse et touch events
            if (event.type.startsWith('touch')) {
                const touch = event.touches[0] || event.changedTouches[0];
                return { clientX: touch.clientX, clientY: touch.clientY };
            }
            return { clientX: event.clientX, clientY: event.clientY };
        }

        let dragging = {
            active: false,
            element: null,
            recipeId: null,
            ingredientId: null,
            placeholder: null,
            startY: 0,
            currentY: 0,
            offsetX: 0,
            offsetY: 0,
            originalRect: null
        };

        function startDrag(event, recipeId, ingredientId) {
            event.preventDefault();
            
            const coords = getEventCoordinates(event);
            
            dragging.active = true;
            dragging.recipeId = recipeId;
            dragging.ingredientId = ingredientId;
            
            // Trouver l'élément parent .shopping-ingredient
            dragging.element = event.target.closest('.shopping-ingredient');
            
            // Stocker la position originale
            const rect = dragging.element.getBoundingClientRect();
            dragging.originalRect = rect;
            dragging.offsetX = coords.clientX - rect.left;
            dragging.offsetY = coords.clientY - rect.top;
            
            // Créer un placeholder à la place de l'élément
            dragging.placeholder = document.createElement('div');
            dragging.placeholder.className = 'shopping-ingredient drag-placeholder';
            dragging.placeholder.style.height = rect.height + 'px';
            dragging.element.parentNode.insertBefore(dragging.placeholder, dragging.element);
            
            // Mettre l'élément en position fixed pour qu'il suive la souris/doigt
            dragging.element.style.position = 'fixed';
            dragging.element.style.width = rect.width + 'px';
            dragging.element.style.left = rect.left + 'px';
            dragging.element.style.top = rect.top + 'px';
            dragging.element.style.zIndex = '10000';
            dragging.element.style.pointerEvents = 'none';
            dragging.element.classList.add('being-dragged');
            
            // Ajouter les listeners pour MOUSE et TOUCH
            document.addEventListener('mousemove', onDragMove);
            document.addEventListener('mouseup', endDrag);
            document.addEventListener('touchmove', onDragMove, { passive: false });
            document.addEventListener('touchend', endDrag);
        }

        function onDragMove(event) {
            if (!dragging.active) return;
            
            // Empêcher le scroll sur mobile pendant le drag
            if (event.type.startsWith('touch')) {
                event.preventDefault();
            }
            
            const coords = getEventCoordinates(event);
            
            // Déplacer l'élément avec la souris/doigt
            dragging.element.style.left = (coords.clientX - dragging.offsetX) + 'px';
            dragging.element.style.top = (coords.clientY - dragging.offsetY) + 'px';
            
            // Trouver l'élément sous la souris/doigt (utiliser le centre de l'élément déplacé)
            const elementBelow = document.elementFromPoint(coords.clientX, coords.clientY);
            const ingredientBelow = elementBelow?.closest('.shopping-ingredient');
            
            if (ingredientBelow && ingredientBelow !== dragging.element && 
                ingredientBelow !== dragging.placeholder) {
                
                // Déterminer si on insère avant ou après
                const rect = ingredientBelow.getBoundingClientRect();
                const midpoint = rect.top + rect.height / 2;
                
                if (coords.clientY < midpoint) {
                    ingredientBelow.parentNode.insertBefore(dragging.placeholder, ingredientBelow);
                } else {
                    ingredientBelow.parentNode.insertBefore(dragging.placeholder, ingredientBelow.nextSibling);
                }
            }
        }

        function endDrag(event) {
            if (!dragging.active) return;
            
            // Remettre l'élément dans le flux normal
            dragging.element.style.position = '';
            dragging.element.style.width = '';
            dragging.element.style.left = '';
            dragging.element.style.top = '';
            dragging.element.style.zIndex = '';
            dragging.element.style.pointerEvents = '';
            dragging.element.classList.remove('being-dragged');
            
            // Si le placeholder est dans le DOM, effectuer le déplacement
            if (dragging.placeholder.parentNode) {
                // Insérer l'élément à la bonne position
                dragging.placeholder.parentNode.insertBefore(dragging.element, dragging.placeholder);
                dragging.placeholder.remove();
                
                // Sauvegarder le nouvel ordre
                updateFlatOrderFromDOM();
            }
            
            // Nettoyer - retirer TOUS les listeners (mouse ET touch)
            document.removeEventListener('mousemove', onDragMove);
            document.removeEventListener('mouseup', endDrag);
            document.removeEventListener('touchmove', onDragMove);
            document.removeEventListener('touchend', endDrag);
            
            dragging = {
                active: false,
                element: null,
                recipeId: null,
                ingredientId: null,
                placeholder: null,
                startY: 0,
                currentY: 0,
                offsetX: 0,
                offsetY: 0,
                originalRect: null
            };
        }

        function updateFlatOrderFromDOM() {
            const section = document.querySelector('.shopping-section');
            if (!section) return;
            
            const newOrder = [];
            const ingredients = section.querySelectorAll('.shopping-ingredient:not(.drag-placeholder)');
            
            ingredients.forEach(ing => {
                const recipeId = ing.dataset.recipeId;
                const ingredientId = ing.dataset.ingredientId;
                if (recipeId && ingredientId) {
                    newOrder.push({ recipeId, ingredientId });
                }
            });
            
            shoppingList.flatOrder = newOrder;
            saveShoppingListToStorage();
        }
    </script>
</body>
</html>

