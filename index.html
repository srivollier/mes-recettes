<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Mes Recettes</title>
    <link rel="icon" type="image/svg+xml" href="favicon.svg">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .main-layout {
            display: flex;
            max-width: 1400px;
            margin: 0 auto;
            gap: 20px;
        }

        .sidebar {
            width: 280px;
            background: white;
            border-radius: 20px;
            padding: 24px 18px;
            box-shadow: 0 8px 24px rgba(0,0,0,0.08);
            height: fit-content;
            max-height: calc(100vh - 40px);
            overflow-y: auto;
            position: sticky;
            top: 20px;
        }

        .sidebar::-webkit-scrollbar {
            width: 5px;
        }

        .sidebar::-webkit-scrollbar-thumb {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border-radius: 10px;
        }

        .sidebar::-webkit-scrollbar-track {
            background: #f8f9ff;
            border-radius: 10px;
        }

        .sidebar-title {
            font-size: 1.4em;
            font-weight: 700;
            color: #667eea;
            margin-bottom: 20px;
            padding-bottom: 16px;
            border-bottom: 2px solid #f0f0f0;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .category-list {
            list-style: none;
        }

        .category-group {
            margin: 8px 0;
            border-bottom: 1px solid #f0f0f0;
            padding-bottom: 8px;
        }

        .category-group:last-child {
            border-bottom: none;
        }

        .category-item {
            padding: 14px 16px;
            border-radius: 10px;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-size: 0.95em;
            user-select: none;
            font-weight: 500;
            margin-bottom: 4px;
        }

        .category-item:hover {
            background: linear-gradient(135deg, #f8f9ff 0%, #f0f0ff 100%);
        }

        .category-item.active {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            font-weight: 600;
            box-shadow: 0 2px 8px rgba(102, 126, 234, 0.3);
        }

        .category-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            width: 100%;
        }

        .category-name {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .category-count {
            background: rgba(0,0,0,0.08);
            padding: 4px 10px;
            border-radius: 14px;
            font-size: 0.8em;
            font-weight: 600;
            min-width: 28px;
            text-align: center;
        }

        .category-item.active .category-count {
            background: rgba(255,255,255,0.25);
        }

        .category-arrow {
            font-size: 0.7em;
            transition: transform 0.3s ease;
            color: #999;
            font-weight: bold;
        }

        .category-item.active .category-arrow {
            color: white;
        }

        .category-item.expanded .category-arrow {
            transform: rotate(90deg);
        }

        .recipe-list {
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.4s ease, padding 0.3s ease;
            padding-left: 0;
            margin-left: 12px;
            border-left: 2px solid #e8e8ff;
        }

        .recipe-list.expanded {
            max-height: 1000px;
            padding-top: 8px;
            padding-bottom: 8px;
            padding-left: 12px;
        }

        .recipe-link {
            display: block;
            padding: 10px 14px;
            margin: 3px 0;
            border-radius: 8px;
            font-size: 0.88em;
            color: #555;
            cursor: pointer;
            transition: all 0.25s ease;
            background: white;
            border: 1px solid transparent;
        }

        .recipe-link:hover {
            background: linear-gradient(135deg, #f8f9ff 0%, #f0f0ff 100%);
            color: #667eea;
            border-color: #e0e0ff;
            transform: translateX(4px);
            box-shadow: 0 2px 6px rgba(102, 126, 234, 0.15);
        }

        .container {
            flex: 1;
            min-width: 0;
        }

        /* Menu burger pour mobile */
        .menu-toggle {
            display: none;
            position: fixed;
            top: 20px;
            left: 20px;
            z-index: 1001;
            background: white;
            border: none;
            border-radius: 50%;
            width: 50px;
            height: 50px;
            font-size: 24px;
            cursor: pointer;
            box-shadow: 0 4px 10px rgba(0,0,0,0.2);
        }

        @media (max-width: 968px) {
            .main-layout {
                flex-direction: column;
            }

            .sidebar {
                position: fixed;
                top: 0;
                left: -320px;
                height: 100vh;
                z-index: 1000;
                transition: left 0.3s ease;
                border-radius: 0 20px 20px 0;
                width: 280px;
                max-height: 100vh;
                box-shadow: 0 0 30px rgba(0,0,0,0.2);
            }

            .sidebar.open {
                left: 0;
            }

            .menu-toggle {
                display: flex;
                align-items: center;
                justify-content: center;
                animation: pulse 2s infinite;
            }

            @keyframes pulse {
                0%, 100% { transform: scale(1); }
                50% { transform: scale(1.05); }
            }

            .sidebar-overlay {
                display: none;
                position: fixed;
                top: 0;
                left: 0;
                right: 0;
                bottom: 0;
                background: rgba(0,0,0,0.5);
                z-index: 999;
                backdrop-filter: blur(2px);
            }

            .sidebar-overlay.show {
                display: block;
            }
        }

        h1 {
            text-align: center;
            color: white;
            margin-bottom: 30px;
            font-size: 2.5em;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
        }

        .header-controls {
            margin-bottom: 30px;
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 15px;
            flex-wrap: wrap;
        }

        .search-bar {
            flex: 1;
            max-width: 500px;
            min-width: 250px;
        }

        .search-bar input {
            width: 100%;
            padding: 15px;
            font-size: 16px;
            border: none;
            border-radius: 25px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }

        .add-recipe-btn {
            padding: 15px 30px;
            background: white;
            color: #667eea;
            border: none;
            border-radius: 25px;
            font-size: 16px;
            font-weight: bold;
            cursor: pointer;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            transition: all 0.3s ease;
            white-space: nowrap;
        }

        .add-recipe-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 12px rgba(0,0,0,0.2);
        }

        .add-recipe-btn:active {
            transform: translateY(0);
        }

        .loading {
            text-align: center;
            color: white;
            font-size: 1.2em;
            margin-top: 50px;
        }

        .error {
            background-color: #ff6b6b;
            color: white;
            padding: 20px;
            border-radius: 10px;
            text-align: center;
            margin: 20px auto;
            max-width: 600px;
        }

        .recipes-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 25px;
            margin-top: 30px;
        }

        .recipe-card {
            background: white;
            border-radius: 15px;
            padding: 25px;
            box-shadow: 0 8px 16px rgba(0,0,0,0.2);
            transition: transform 0.3s ease, box-shadow 0.3s ease;
            cursor: pointer;
        }

        .recipe-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 12px 24px rgba(0,0,0,0.3);
        }

        .recipe-name {
            font-size: 1.5em;
            color: #667eea;
            margin-bottom: 10px;
            font-weight: bold;
        }

        .recipe-category {
            display: inline-block;
            background: #667eea;
            color: white;
            padding: 5px 15px;
            border-radius: 20px;
            font-size: 0.9em;
            margin-bottom: 15px;
        }

        .recipe-info {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            margin-bottom: 15px;
        }

        .recipe-info-item {
            background: #f0f0f0;
            padding: 5px 10px;
            border-radius: 10px;
            font-size: 0.85em;
            color: #555;
        }

        .recipe-details {
            color: #555;
            line-height: 1.6;
        }

        .recipe-details p {
            margin: 8px 0;
        }

        .recipe-details strong {
            color: #333;
        }

        .recipe-section {
            margin-top: 15px;
            padding-top: 15px;
            border-top: 1px solid #e0e0e0;
        }

        .recipe-subsection {
            margin-top: 12px;
            margin-left: 15px;
            padding-left: 15px;
            border-left: 3px solid #667eea;
        }

        .section-title {
            color: #667eea;
            font-size: 1.05em;
            display: block;
            margin-bottom: 5px;
        }

        .no-results {
            text-align: center;
            color: white;
            font-size: 1.2em;
            margin-top: 50px;
        }

        .config-section {
            background: rgba(255, 255, 255, 0.95);
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 30px;
            text-align: center;
        }

        .config-section input {
            width: 100%;
            max-width: 600px;
            padding: 10px;
            margin: 10px 0;
            border: 2px solid #667eea;
            border-radius: 5px;
        }

        .config-section button {
            background: #667eea;
            color: white;
            padding: 10px 30px;
            border: none;
            border-radius: 25px;
            cursor: pointer;
            font-size: 16px;
            margin-top: 10px;
        }

        .config-section button:hover {
            background: #764ba2;
        }

        .stats {
            text-align: center;
            color: white;
            margin-bottom: 20px;
            font-size: 1.1em;
        }

        .filter-section {
            text-align: center;
            margin-bottom: 20px;
        }

        .filter-buttons {
            display: flex;
            flex-wrap: wrap;
            justify-content: center;
            gap: 10px;
            margin-top: 10px;
        }

        .filter-btn {
            background: rgba(255, 255, 255, 0.9);
            color: #667eea;
            padding: 8px 20px;
            border: 2px solid white;
            border-radius: 20px;
            cursor: pointer;
            font-size: 14px;
            transition: all 0.3s ease;
        }

        .filter-btn:hover {
            background: white;
            transform: scale(1.05);
        }

        .filter-btn.active {
            background: #667eea;
            color: white;
        }

        /* Modal pour vue d√©taill√©e */
        .modal-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.8);
            z-index: 1000;
            overflow-y: auto;
            padding: 20px;
        }

        .modal-overlay.active {
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .modal-content {
            background: white;
            border-radius: 20px;
            max-width: 800px;
            width: 100%;
            max-height: 90vh;
            overflow-y: auto;
            padding: 40px;
            position: relative;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            animation: modalFadeIn 0.3s ease;
        }

        @keyframes modalFadeIn {
            from {
                opacity: 0;
                transform: scale(0.9);
            }
            to {
                opacity: 1;
                transform: scale(1);
            }
        }

        .modal-close {
            position: absolute;
            top: 20px;
            right: 20px;
            background: #667eea;
            color: white;
            border: none;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            font-size: 24px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: transform 0.2s ease, background 0.2s ease;
        }

        .modal-close:hover {
            background: #764ba2;
            transform: rotate(90deg);
        }

        .modal-recipe-name {
            font-size: 2.5em;
            color: #667eea;
            margin-bottom: 15px;
            font-weight: bold;
            padding-right: 50px;
        }

        .modal-recipe-category {
            display: inline-block;
            background: #667eea;
            color: white;
            padding: 8px 20px;
            border-radius: 25px;
            font-size: 1em;
            margin-bottom: 20px;
        }

        .modal-recipe-info {
            display: flex;
            flex-wrap: wrap;
            gap: 15px;
            margin-bottom: 30px;
            padding-bottom: 20px;
            border-bottom: 2px solid #e0e0e0;
        }

        .modal-info-item {
            background: #f0f0f0;
            padding: 10px 20px;
            border-radius: 15px;
            font-size: 1em;
            color: #555;
        }

        .modal-section {
            margin-top: 30px;
        }

        .modal-section-title {
            font-size: 1.8em;
            color: #333;
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .modal-subsection {
            margin-top: 20px;
            margin-left: 20px;
            padding-left: 20px;
            border-left: 4px solid #667eea;
        }

        .modal-subsection-title {
            color: #667eea;
            font-size: 1.3em;
            font-weight: bold;
            margin-bottom: 10px;
        }

        .modal-content p {
            line-height: 1.8;
            color: #555;
            white-space: pre-line;
        }

        /* Optimisation mobile */
        @media (max-width: 768px) {
            .modal-overlay {
                padding: 0;
                align-items: flex-start;
            }

            .modal-content {
                max-width: 100%;
                width: 100%;
                max-height: 100vh;
                border-radius: 0;
                padding: 20px;
                margin: 0;
            }

            .modal-close {
                top: 10px;
                right: 10px;
                width: 35px;
                height: 35px;
                font-size: 20px;
            }

            .modal-recipe-name {
                font-size: 1.8em;
                padding-right: 40px;
                margin-bottom: 10px;
            }

            .modal-recipe-category {
                font-size: 0.9em;
                padding: 6px 15px;
            }

            .modal-recipe-info {
                gap: 10px;
                margin-bottom: 20px;
            }

            .modal-info-item {
                padding: 8px 15px;
                font-size: 0.9em;
            }

            .modal-section {
                margin-top: 20px;
            }

            .modal-section-title {
                font-size: 1.4em;
                margin-bottom: 12px;
            }

            .modal-subsection {
                margin-top: 15px;
                margin-left: 10px;
                padding-left: 15px;
                border-left: 3px solid #667eea;
            }

            .modal-subsection-title {
                font-size: 1.1em;
                margin-bottom: 8px;
            }

            .modal-content p {
                font-size: 0.95em;
                line-height: 1.7;
            }
        }

        /* Tr√®s petits √©crans */
        @media (max-width: 480px) {
            .modal-recipe-name {
                font-size: 1.5em;
            }

            .modal-section-title {
                font-size: 1.2em;
            }

            .modal-subsection-title {
                font-size: 1em;
            }

            .modal-info-item {
                font-size: 0.85em;
                padding: 6px 12px;
            }
        }

        /* Panneau lat√©ral coulissant pour ingr√©dients (mobile) */
        .ingredients-drawer {
            display: none;
            position: fixed;
            top: 0;
            left: -100%;
            width: 80%;
            max-width: 320px;
            height: 100vh;
            background: white;
            box-shadow: 2px 0 20px rgba(0,0,0,0.3);
            z-index: 2000;
            transition: left 0.3s ease;
            overflow-y: auto;
            padding: 20px;
        }

        .ingredients-drawer.open {
            left: 0;
        }

        .ingredients-drawer-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.5);
            z-index: 1999;
        }

        .ingredients-drawer-overlay.show {
            display: block;
        }

        .drawer-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 2px solid #667eea;
        }

        .drawer-title {
            font-size: 1.3em;
            color: #667eea;
            font-weight: bold;
        }

        .drawer-close {
            background: #667eea;
            color: white;
            border: none;
            border-radius: 50%;
            width: 35px;
            height: 35px;
            font-size: 20px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .drawer-section {
            margin-bottom: 20px;
        }

        .drawer-section-title {
            color: #667eea;
            font-weight: bold;
            font-size: 1.1em;
            margin-bottom: 10px;
        }

        .drawer-content {
            line-height: 1.7;
            color: #555;
            white-space: pre-line;
        }

        /* Bouton pour ouvrir le drawer */
        .open-ingredients-btn {
            display: none;
            position: fixed;
            bottom: 20px;
            right: 20px;
            background: #667eea;
            color: white;
            border: none;
            border-radius: 50%;
            width: 60px;
            height: 60px;
            font-size: 28px;
            cursor: pointer;
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.4);
            z-index: 1998;
            transition: transform 0.2s ease;
        }

        .open-ingredients-btn:active {
            transform: scale(0.9);
        }

        @media (max-width: 768px) {
            .ingredients-drawer {
                display: block;
            }
            
            .open-ingredients-btn {
                display: flex;
                align-items: center;
                justify-content: center;
            }
        }

        /* Mode √©tape par √©tape */
        .step-by-step-mode {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: white;
            z-index: 3000;
            overflow-y: auto;
        }

        .step-by-step-mode.active {
            display: block;
        }

        .step-header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }

        .step-header-title {
            font-size: 1.2em;
            font-weight: bold;
        }

        .step-header-actions {
            display: flex;
            gap: 10px;
            align-items: center;
        }

        .step-back-btn {
            background: rgba(255,255,255,0.2);
            color: white;
            border: none;
            border-radius: 10px;
            padding: 10px 15px;
            font-size: 0.9em;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 5px;
        }

        .step-back-btn:hover {
            background: rgba(255,255,255,0.3);
            transform: translateX(-2px);
        }

        @media (max-width: 768px) {
            .step-back-btn {
                font-size: 0.85em;
                padding: 8px 12px;
            }
        }

        .step-close-btn {
            background: rgba(255,255,255,0.2);
            color: white;
            border: none;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            font-size: 24px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .step-progress {
            background: #f0f0f0;
            padding: 15px 20px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            border-bottom: 1px solid #e0e0e0;
        }

        .step-counter {
            font-weight: bold;
            color: #667eea;
            font-size: 1.1em;
        }

        .step-progress-bar {
            flex: 1;
            height: 6px;
            background: #e0e0e0;
            border-radius: 10px;
            margin: 0 15px;
            overflow: hidden;
        }

        .step-progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #667eea 0%, #764ba2 100%);
            border-radius: 10px;
            transition: width 0.3s ease;
        }

        .step-content {
            padding: 30px 20px;
            min-height: calc(100vh - 240px);
            padding-bottom: 100px;
        }

        .step-section-title {
            color: #667eea;
            font-size: 0.9em;
            text-transform: uppercase;
            letter-spacing: 1px;
            margin-bottom: 10px;
            font-weight: bold;
        }

        .step-text {
            font-size: 1.4em;
            line-height: 1.8;
            color: #333;
            margin-bottom: 30px;
        }

        .step-ingredients-box {
            background: #f8f9ff;
            border-left: 4px solid #667eea;
            padding: 15px;
            margin-top: 20px;
            border-radius: 5px;
        }

        .step-ingredients-title {
            font-weight: bold;
            color: #667eea;
            margin-bottom: 10px;
        }

        .step-ingredients-list {
            font-size: 0.95em;
            line-height: 1.6;
            color: #555;
            white-space: pre-line;
        }

        .step-navigation {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            background: white;
            padding: 15px 20px;
            display: flex;
            gap: 10px;
            border-top: 2px solid #e0e0e0;
            box-shadow: 0 -2px 10px rgba(0,0,0,0.1);
        }

        .step-nav-btn {
            flex: 1;
            padding: 15px;
            border: none;
            border-radius: 10px;
            font-size: 1.1em;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .step-nav-btn:disabled {
            opacity: 0.3;
            cursor: not-allowed;
        }

        .step-prev-btn {
            background: #f0f0f0;
            color: #667eea;
        }

        .step-prev-btn:active:not(:disabled) {
            background: #e0e0e0;
        }

        .step-next-btn {
            background: #667eea;
            color: white;
        }

        .step-next-btn:active:not(:disabled) {
            background: #764ba2;
        }

        .step-finish-btn {
            background: #4CAF50;
            color: white;
        }

        .step-finish-btn:active {
            background: #45a049;
        }

        /* Bouton pour activer le mode */
        .activate-step-mode-btn {
            display: block;
            width: 100%;
            padding: 15px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            border-radius: 10px;
            font-size: 1.1em;
            font-weight: bold;
            cursor: pointer;
            margin-top: 20px;
            box-shadow: 0 4px 10px rgba(102, 126, 234, 0.3);
            transition: all 0.3s ease;
        }

        .activate-step-mode-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 15px rgba(102, 126, 234, 0.4);
        }

        .activate-step-mode-btn:active {
            transform: translateY(0);
        }

        /* Bouton pour voir tous les ingr√©dients en mode √©tape par √©tape */
        .step-all-ingredients-btn {
            position: fixed;
            bottom: 90px;
            right: 20px;
            width: 60px;
            height: 60px;
            background: linear-gradient(135deg, #4CAF50 0%, #45a049 100%);
            color: white;
            border: none;
            border-radius: 50%;
            font-size: 24px;
            cursor: pointer;
            box-shadow: 0 4px 15px rgba(76, 175, 80, 0.4);
            z-index: 3001;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s ease;
        }

        .step-all-ingredients-btn:hover {
            transform: scale(1.1);
            box-shadow: 0 6px 20px rgba(76, 175, 80, 0.5);
        }

        .step-all-ingredients-btn:active {
            transform: scale(0.95);
        }

        /* Drawer pour tous les ingr√©dients en mode √©tape par √©tape */
        .step-ingredients-drawer {
            position: fixed;
            top: 0;
            right: -100%;
            width: 350px;
            max-width: 90vw;
            height: 100%;
            background: white;
            box-shadow: -4px 0 15px rgba(0, 0, 0, 0.2);
            z-index: 3002;
            transition: right 0.3s ease;
            overflow-y: auto;
        }

        .step-ingredients-drawer.open {
            right: 0;
        }

        .step-drawer-header {
            background: linear-gradient(135deg, #4CAF50 0%, #45a049 100%);
            color: white;
            padding: 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            position: sticky;
            top: 0;
            z-index: 1;
        }

        .step-drawer-title {
            font-size: 1.2em;
            font-weight: bold;
        }

        .step-drawer-close {
            background: rgba(255,255,255,0.2);
            color: white;
            border: none;
            border-radius: 50%;
            width: 35px;
            height: 35px;
            font-size: 20px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .step-drawer-content {
            padding: 20px;
        }

        .step-drawer-section {
            margin-bottom: 25px;
        }

        .step-drawer-section-title {
            color: #4CAF50;
            font-weight: bold;
            font-size: 1.1em;
            margin-bottom: 10px;
            padding-bottom: 5px;
            border-bottom: 2px solid #4CAF50;
        }

        .step-drawer-section-content {
            white-space: pre-line;
            line-height: 1.6;
            color: #333;
        }

        .step-drawer-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.5);
            z-index: 3001;
            display: none;
        }

        .step-drawer-overlay.show {
            display: block;
        }

        @media (max-width: 768px) {
            .step-ingredients-drawer {
                width: 100%;
                max-width: 100%;
            }
        }

        /* Modal d'import CSV */
        .import-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.7);
            z-index: 4000;
            align-items: center;
            justify-content: center;
        }

        .import-modal.active {
            display: flex;
        }

        .import-modal-content {
            background: white;
            border-radius: 15px;
            max-width: 700px;
            width: 90%;
            max-height: 80vh;
            overflow-y: auto;
            box-shadow: 0 10px 40px rgba(0,0,0,0.3);
        }

        .import-modal-header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px 30px;
            border-radius: 15px 15px 0 0;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .import-modal-title {
            font-size: 1.5em;
            font-weight: bold;
        }

        .import-modal-close {
            background: rgba(255,255,255,0.2);
            color: white;
            border: none;
            border-radius: 50%;
            width: 35px;
            height: 35px;
            font-size: 24px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .import-modal-body {
            padding: 30px;
        }

        .import-instructions {
            background: #f8f9ff;
            border-left: 4px solid #667eea;
            padding: 15px;
            margin-bottom: 20px;
            border-radius: 5px;
            font-size: 0.95em;
            line-height: 1.6;
        }

        .import-instructions strong {
            color: #667eea;
        }

        .csv-input-label {
            display: block;
            font-weight: bold;
            color: #333;
            margin-bottom: 10px;
        }

        .csv-textarea {
            width: 100%;
            min-height: 200px;
            padding: 15px;
            border: 2px solid #e0e0e0;
            border-radius: 10px;
            font-family: 'Courier New', monospace;
            font-size: 13px;
            resize: vertical;
            transition: border-color 0.3s ease;
        }

        .csv-textarea:focus {
            outline: none;
            border-color: #667eea;
        }

        .import-actions {
            display: flex;
            gap: 10px;
            margin-top: 20px;
        }

        .import-btn {
            flex: 1;
            padding: 15px;
            border: none;
            border-radius: 10px;
            font-size: 1em;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .import-btn-primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }

        .import-btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 15px rgba(102, 126, 234, 0.4);
        }

        .import-btn-secondary {
            background: #f0f0f0;
            color: #666;
        }

        .import-btn-secondary:hover {
            background: #e0e0e0;
        }

        .import-status {
            margin-top: 15px;
            padding: 15px;
            border-radius: 10px;
            display: none;
        }

        .import-status.success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
            display: block;
        }

        .import-status.error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
            display: block;
        }

        .import-status.loading {
            background: #d1ecf1;
            color: #0c5460;
            border: 1px solid #bee5eb;
            display: block;
        }

        /* Ajusteur de portions */
        .portion-adjuster {
            background: linear-gradient(135deg, #f8f9ff 0%, #fff 100%);
            border: 2px solid #667eea;
            border-radius: 15px;
            padding: 0;
            margin: 20px 0;
            box-shadow: 0 4px 15px rgba(102, 126, 234, 0.1);
            overflow: hidden;
            transition: all 0.3s ease;
        }

        .portion-adjuster-header {
            padding: 15px 20px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: space-between;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            transition: all 0.3s ease;
        }

        .portion-adjuster-header:hover {
            background: linear-gradient(135deg, #5568d3 0%, #653a8a 100%);
        }

        .portion-adjuster-header-text {
            display: flex;
            align-items: center;
            gap: 10px;
            font-weight: 600;
            font-size: 1.05em;
        }

        .portion-adjuster-toggle-icon {
            font-size: 1.2em;
            transition: transform 0.3s ease;
        }

        .portion-adjuster.collapsed .portion-adjuster-toggle-icon {
            transform: rotate(-90deg);
        }

        .portion-adjuster-content {
            padding: 20px;
            max-height: 500px;
            opacity: 1;
            transition: all 0.3s ease;
        }

        .portion-adjuster.collapsed .portion-adjuster-content {
            max-height: 0;
            opacity: 0;
            padding: 0 20px;
            overflow: hidden;
        }

        .portion-adjuster-title {
            font-size: 0.95em;
            font-weight: 600;
            color: #667eea;
            margin-bottom: 15px;
            text-align: center;
        }

        .portion-controls {
            display: flex;
            align-items: center;
            gap: 15px;
            justify-content: center;
        }

        .portion-btn {
            width: 45px;
            height: 45px;
            border: none;
            border-radius: 50%;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            font-size: 24px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 2px 8px rgba(102, 126, 234, 0.3);
        }

        .portion-btn:hover {
            transform: scale(1.1);
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.4);
        }

        .portion-btn:active {
            transform: scale(0.95);
        }

        .portion-display {
            flex: 1;
            text-align: center;
            padding: 0 20px;
        }

        .portion-number {
            font-size: 2.5em;
            font-weight: bold;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .portion-label {
            font-size: 0.95em;
            color: #666;
            margin-top: 5px;
        }

        .portion-original {
            font-size: 0.85em;
            color: #999;
            font-style: italic;
            margin-top: 8px;
        }

        .ingredient-adjusted {
            color: #667eea;
            font-weight: 500;
            transition: all 0.3s ease;
        }

        .portion-reset-btn {
            margin-top: 10px;
            padding: 8px 16px;
            background: #f0f0f0;
            border: none;
            border-radius: 8px;
            color: #666;
            font-size: 0.85em;
            cursor: pointer;
            transition: all 0.3s ease;
            margin-right: 10px;
        }

        .portion-reset-btn:hover {
            background: #e0e0e0;
            color: #667eea;
        }

        .portion-adjuster center {
            display: flex;
            justify-content: center;
            align-items: center;
            flex-wrap: wrap;
            gap: 10px;
        }

        /* Ajustement individuel d'ingr√©dients */
        .ingredient-line {
            padding: 5px 0;
            line-height: 1.6;
        }

        .editable-quantity {
            display: inline-block;
            padding: 2px 6px;
            border-radius: 4px;
            cursor: default;
            transition: all 0.2s ease;
            background: transparent;
            border: 1px solid transparent;
            min-width: 30px;
            text-align: center;
        }

        .edit-mode-active .editable-quantity {
            cursor: pointer;
            background: #fffef0;
            border-color: #fbbf24;
        }

        .edit-mode-active .editable-quantity:hover {
            background: #fef3c7;
            border-color: #f59e0b;
            box-shadow: 0 0 0 2px rgba(245, 158, 11, 0.2);
        }

        .editable-quantity:focus {
            outline: none;
            background: white;
            border-color: #f59e0b;
            box-shadow: 0 0 0 3px rgba(245, 158, 11, 0.3);
        }

        .edit-mode-toggle-btn {
            margin-top: 10px;
            padding: 10px 20px;
            background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%);
            color: white;
            border: none;
            border-radius: 10px;
            font-size: 0.95em;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            box-shadow: 0 2px 8px rgba(245, 158, 11, 0.3);
        }

        .edit-mode-toggle-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(245, 158, 11, 0.4);
        }

        .edit-mode-toggle-btn.active {
            background: linear-gradient(135deg, #10b981 0%, #059669 100%);
            box-shadow: 0 2px 8px rgba(16, 185, 129, 0.3);
        }

        .edit-mode-toggle-btn.active:hover {
            box-shadow: 0 4px 12px rgba(16, 185, 129, 0.4);
        }

        .edit-mode-banner {
            background: linear-gradient(135deg, #fef3c7 0%, #fde68a 100%);
            border: 2px solid #f59e0b;
            border-radius: 10px;
            padding: 12px 16px;
            margin-bottom: 15px;
            display: none;
            align-items: center;
            gap: 10px;
            font-size: 0.9em;
            color: #92400e;
            font-weight: 600;
            animation: slideIn 0.3s ease;
        }

        .edit-mode-active .edit-mode-banner {
            display: flex;
        }

        @keyframes slideIn {
            from {
                opacity: 0;
                transform: translateY(-10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .ingredient-modified-indicator {
            display: inline-block;
            width: 6px;
            height: 6px;
            background: #f59e0b;
            border-radius: 50%;
            margin-left: 4px;
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }
    </style>
</head>
<body>
    <!-- Bouton menu burger (mobile) -->
    <button class="menu-toggle" id="menuToggle" onclick="toggleSidebar()">
        ‚ò∞
    </button>

    <!-- Overlay pour fermer la sidebar sur mobile -->
    <div class="sidebar-overlay" id="sidebarOverlay" onclick="closeSidebar()"></div>

    <div class="main-layout">
        <!-- Sidebar avec les cat√©gories -->
        <aside class="sidebar" id="sidebar">
            <div class="sidebar-title">
                üìÇ Cat√©gories
            </div>
            <ul class="category-list" id="categoryList">
                <li class="category-item active" onclick="filterByCategory('all')">
                    <span>üìö Toutes les recettes</span>
                    <span class="category-count" id="count-all">0</span>
                </li>
            </ul>
        </aside>

        <!-- Contenu principal -->
        <div class="container">
            <h1>üç≥ Mes Recettes</h1>

            <div class="config-section" id="configSection">
            <h3>Configuration</h3>
            <p>Entrez l'URL de votre Web App Google Apps Script :</p>
            <input type="text" id="webAppUrl" placeholder="https://script.google.com/macros/s/.../exec">
            <br>
            <button onclick="saveConfig()">Enregistrer</button>
            <br><br>
            <small style="color: #666;">
                Pour obtenir cette URL, d√©ployez votre script Google Apps Script en tant que Web App.
                <br>Consultez le README.md pour plus d'instructions.
            </small>
        </div>

        <div id="mainContent" style="display: none;">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                <div class="stats" id="stats"></div>
                <button onclick="showConfigSection()" style="background: rgba(255,255,255,0.9); color: #667eea; padding: 8px 16px; border: none; border-radius: 20px; cursor: pointer; font-size: 14px;">
                    ‚öôÔ∏è Changer l'URL
                </button>
            </div>

            <div class="header-controls">
                <div class="search-bar">
                    <input type="text" id="searchInput" placeholder="üîç Rechercher une recette..." onkeyup="filterRecipes()">
                </div>
                <button class="add-recipe-btn" onclick="openImportModal()">
                    ‚ûï Ajouter une recette
                </button>
            </div>

            <div class="loading" id="loading" style="display: none;">
                Chargement des recettes...
            </div>

            <div id="error"></div>
            <div class="recipes-grid" id="recipesGrid"></div>
        </div>
    </div>

    <!-- Modal pour vue d√©taill√©e -->
    <div class="modal-overlay" id="recipeModal" onclick="closeRecipeModal()">
        <div class="modal-content" onclick="event.stopPropagation()">
            <button class="modal-close" onclick="closeRecipeModal()">√ó</button>
            <div id="modalRecipeContent"></div>
        </div>
    </div>

    <!-- Panneau lat√©ral pour ingr√©dients (mobile) -->
    <div class="ingredients-drawer-overlay" id="ingredientsDrawerOverlay" onclick="closeIngredientsDrawer()"></div>
    <div class="ingredients-drawer" id="ingredientsDrawer">
        <div class="drawer-header">
            <div class="drawer-title">üìã Ingr√©dients</div>
            <button class="drawer-close" onclick="closeIngredientsDrawer()">√ó</button>
        </div>
        <div id="drawerIngredientsContent"></div>
    </div>

    <!-- Bouton flottant pour ouvrir le drawer -->
    <button class="open-ingredients-btn" id="openIngredientsBtn" onclick="openIngredientsDrawer()" style="display: none;">
        üìã
    </button>

    <!-- Modal d'import CSV -->
    <div class="import-modal" id="importModal">
        <div class="import-modal-content" onclick="event.stopPropagation()">
            <div class="import-modal-header">
                <div class="import-modal-title">‚ûï Ajouter une nouvelle recette</div>
                <button class="import-modal-close" onclick="closeImportModal()">√ó</button>
            </div>
            <div class="import-modal-body">
                <div class="import-instructions">
                    <strong>üìã Comment importer votre recette :</strong><br>
                    1. Demandez √† votre assistant GPT de g√©n√©rer le CSV<br>
                    2. Copiez le CSV complet (en-t√™te + donn√©es)<br>
                    3. Collez-le ci-dessous<br>
                    4. Cliquez sur "Importer la recette"
                </div>
                
                <label class="csv-input-label">Collez votre CSV ici :</label>
                <textarea 
                    id="csvTextarea" 
                    class="csv-textarea" 
                    placeholder='Nom,Cat√©gorie,Portions,Temps de pr√©paration,Temps de cuisson,Difficult√©,Ingr√©dients - P√¢te,...
"Ma recette","Plat principal","4 personnes","30 min","45 min","Moyen","- 200g de farine..."'
                ></textarea>
                
                <div class="import-actions">
                    <button class="import-btn import-btn-secondary" onclick="closeImportModal()">
                        Annuler
                    </button>
                    <button class="import-btn import-btn-primary" onclick="importRecipeFromCSV()">
                        ‚úÖ Importer la recette
                    </button>
                </div>
                
                <div class="import-status" id="importStatus"></div>
            </div>
        </div>
    </div>

        </div> <!-- fin container -->
    </div> <!-- fin main-layout -->

    <!-- Mode √©tape par √©tape -->
    <div class="step-by-step-mode" id="stepByStepMode">
        <div class="step-header">
            <div class="step-header-title" id="stepHeaderTitle">Mode √âtape par √âtape</div>
            <div class="step-header-actions">
                <button class="step-back-btn" onclick="backToRecipe()">
                    ‚Üê Retour √† la recette
                </button>
                <button class="step-close-btn" onclick="closeStepByStep()">√ó</button>
            </div>
        </div>
        
        <div class="step-progress">
            <div class="step-counter" id="stepCounter">√âtape 1/1</div>
            <div class="step-progress-bar">
                <div class="step-progress-fill" id="stepProgressFill" style="width: 0%"></div>
            </div>
        </div>
        
        <div class="step-content" id="stepContent">
            <div class="step-section-title" id="stepSectionTitle"></div>
            <div class="step-text" id="stepText"></div>
            <div class="step-ingredients-box" id="stepIngredientsBox" style="display: none;">
                <div class="step-ingredients-title">üìã Ingr√©dients pour cette √©tape :</div>
                <div class="step-ingredients-list" id="stepIngredientsList"></div>
            </div>
        </div>
        
        <div class="step-navigation">
            <button class="step-nav-btn step-prev-btn" id="stepPrevBtn" onclick="previousStep()">‚Üê Pr√©c√©dent</button>
            <button class="step-nav-btn step-next-btn" id="stepNextBtn" onclick="nextStep()">Suivant ‚Üí</button>
        </div>

        <!-- Bouton pour voir tous les ingr√©dients -->
        <button class="step-all-ingredients-btn" id="stepAllIngredientsBtn" onclick="openStepIngredientsDrawer()" style="display: none;">
            üìã
        </button>

        <!-- Drawer avec tous les ingr√©dients -->
        <div class="step-drawer-overlay" id="stepDrawerOverlay" onclick="closeStepIngredientsDrawer()"></div>
        <div class="step-ingredients-drawer" id="stepIngredientsDrawer">
            <div class="step-drawer-header">
                <div class="step-drawer-title">üìã Tous les Ingr√©dients</div>
                <button class="step-drawer-close" onclick="closeStepIngredientsDrawer()">√ó</button>
            </div>
            <div class="step-drawer-content" id="stepDrawerContent"></div>
        </div>
    </div>

    <script>
        let allRecipes = [];
        let filteredRecipes = [];
        let activeCategory = 'all';
        
        // ‚öôÔ∏è CONFIGURATION : Remplacez cette URL par celle de votre Web App Google Apps Script
        const DEFAULT_WEB_APP_URL = 'https://script.google.com/macros/s/AKfycbxgK2cGOJ38dt5dz8sH0kpmJxIFmnlFfFnGELQbaXxldNk-PVRVM71IexafmWxb4gfZbw/exec'; // <- Remplacez par votre URL
        
        let webAppUrl = localStorage.getItem('webAppUrl') || DEFAULT_WEB_APP_URL;

        // Variables pour le mode √©tape par √©tape
        let stepByStepData = {
            recipe: null,
            steps: [],
            currentStepIndex: 0
        };
        let currentRecipeForStepMode = null; // Stockage temporaire pour √©viter les probl√®mes de s√©rialisation

        // V√©rifier si l'URL est configur√©e au chargement
        window.addEventListener('DOMContentLoaded', () => {
            // Toujours masquer la config et charger les recettes
            document.getElementById('configSection').style.display = 'none';
            document.getElementById('mainContent').style.display = 'block';
            
            // Si l'URL par d√©faut n'a pas √©t√© remplac√©e, afficher un message
            if (webAppUrl === 'VOTRE_URL_ICI') {
                document.getElementById('error').innerHTML = `
                    <div class="error">
                        <strong>Configuration requise</strong><br>
                        Veuillez configurer l'URL de votre Web App dans le fichier index.html<br>
                        ou cliquez sur le bouton ci-dessous pour la configurer.<br><br>
                        <button onclick="showConfigSection()" style="padding: 10px 20px; background: white; color: #667eea; border: none; border-radius: 5px; cursor: pointer; font-size: 16px;">
                            ‚öôÔ∏è Configurer l'URL
                        </button>
                    </div>
                `;
            } else {
                loadRecipes();
            }
        });

        function showConfigSection() {
            document.getElementById('configSection').style.display = 'block';
            document.getElementById('mainContent').style.display = 'none';
            document.getElementById('webAppUrl').value = webAppUrl === 'VOTRE_URL_ICI' ? '' : webAppUrl;
        }

        function saveConfig() {
            const url = document.getElementById('webAppUrl').value.trim();
            if (url) {
                localStorage.setItem('webAppUrl', url);
                webAppUrl = url;
                document.getElementById('configSection').style.display = 'none';
                document.getElementById('mainContent').style.display = 'block';
                document.getElementById('error').innerHTML = '';
                loadRecipes();
            } else {
                alert('Veuillez entrer une URL valide');
            }
        }

        async function loadRecipes() {
            const loading = document.getElementById('loading');
            const error = document.getElementById('error');
            const recipesGrid = document.getElementById('recipesGrid');

            loading.style.display = 'block';
            error.innerHTML = '';
            recipesGrid.innerHTML = '';

            try {
                const response = await fetch(webAppUrl);
                if (!response.ok) {
                    throw new Error('Erreur lors du chargement des recettes');
                }

                const data = await response.json();
                allRecipes = data.recipes || [];
                console.log('Recettes re√ßues:', allRecipes);
console.log('Premi√®re recette:', allRecipes[0]);
                filteredRecipes = allRecipes;

                loading.style.display = 'none';

                if (allRecipes.length === 0) {
                    recipesGrid.innerHTML = '<div class="no-results">Aucune recette trouv√©e. Commencez par cr√©er votre premi√®re recette dans Google Sheets !</div>';
                    return;
                }

                updateStats();
                createCategoryFilters();
                displayRecipes(allRecipes);

            } catch (err) {
                loading.style.display = 'none';
                error.innerHTML = `
                    <div class="error">
                        <strong>Erreur :</strong> ${err.message}<br>
                        <small>V√©rifiez que votre Web App est correctement d√©ploy√©e et accessible.</small><br>
                        <button onclick="location.reload()" style="margin-top: 10px; padding: 10px 20px; background: white; color: #ff6b6b; border: none; border-radius: 5px; cursor: pointer;">
                            Recharger
                        </button>
                        <button onclick="reconfigureApp()" style="margin-top: 10px; padding: 10px 20px; background: white; color: #667eea; border: none; border-radius: 5px; cursor: pointer; margin-left: 10px;">
                            Reconfigurer
                        </button>
                    </div>
                `;
            }
        }

        function reconfigureApp() {
            localStorage.removeItem('webAppUrl');
            location.reload();
        }

        function updateStats() {
            const stats = document.getElementById('stats');
            stats.innerHTML = `üìö ${allRecipes.length} recette${allRecipes.length > 1 ? 's' : ''} disponible${allRecipes.length > 1 ? 's' : ''}`;
        }

        function createCategoryFilters() {
            const categoriesMap = {};
            
            // Grouper les recettes par cat√©gorie
            allRecipes.forEach(recipe => {
                const cat = recipe.categorie || 'Sans cat√©gorie';
                if (!categoriesMap[cat]) {
                    categoriesMap[cat] = [];
                }
                categoriesMap[cat].push(recipe);
            });

            // Mettre √† jour le compte "Toutes les recettes"
            document.getElementById('count-all').textContent = allRecipes.length;

            // Cr√©er la liste des cat√©gories
            const categoryList = document.getElementById('categoryList');
            let html = `
                <li class="category-item active" onclick="filterByCategory('all', event)" style="margin-bottom: 12px;">
                    <div class="category-header">
                        <div class="category-name">
                            <span>üìö Toutes les recettes</span>
                        </div>
                        <span class="category-count" id="count-all">${allRecipes.length}</span>
                    </div>
                </li>
            `;

            // Emoji par cat√©gorie
            const categoryEmojis = {
                'Entr√©e': 'ü•ó',
                'Plat principal': 'üçΩÔ∏è',
                'Accompagnement': 'ü•ò',
                'Dessert': 'üç∞',
                'Boisson': 'üçπ',
                'Sauce': 'ü•´',
                'Petit-d√©jeuner': 'ü•ê',
                'Go√ªter': 'üßÅ',
                'Ap√©ritif': 'üç∏'
            };

            // Trier les cat√©gories alphab√©tiquement
            const sortedCategories = Object.keys(categoriesMap).sort();

            sortedCategories.forEach(cat => {
                const recipes = categoriesMap[cat];
                const emoji = categoryEmojis[cat] || 'üìñ';
                const safeCat = cat.replace(/'/g, "\\'");
                const categoryId = 'cat-' + cat.replace(/[^a-zA-Z0-9]/g, '-');
                
                // Trier les recettes par ordre alphab√©tique
                const sortedRecipes = recipes.sort((a, b) => 
                    (a.nom || '').localeCompare(b.nom || '')
                );
                
                html += `
                    <li class="category-group">
                        <div class="category-item" onclick="toggleCategory('${categoryId}', '${safeCat}', event)">
                            <div class="category-header">
                                <div class="category-name">
                                    <span>${emoji} ${cat}</span>
                                    <span class="category-arrow">‚ñ∂</span>
                                </div>
                                <span class="category-count">${recipes.length}</span>
                            </div>
                        </div>
                        <div class="recipe-list" id="${categoryId}">
                `;
                
                // Ajouter chaque recette
                sortedRecipes.forEach(recipe => {
                    const recipeIndex = allRecipes.indexOf(recipe);
                    html += `
                        <div class="recipe-link" onclick="openRecipeFromMenu(${recipeIndex}); event.stopPropagation();">
                            ${recipe.nom || 'Sans nom'}
                        </div>
                    `;
                });
                
                html += `
                        </div>
                    </li>
                `;
            });

            categoryList.innerHTML = html;
        }

        function toggleCategory(categoryId, categoryName, event) {
            if (event) event.stopPropagation();
            
            const categoryElement = document.getElementById(categoryId);
            const categoryItem = event.target.closest('.category-item');
            
            // Toggle expanded class
            const isExpanded = categoryElement.classList.contains('expanded');
            categoryItem.classList.toggle('expanded');
            categoryElement.classList.toggle('expanded');
            
            // Si on ouvre la cat√©gorie, filtrer aussi les recettes
            if (!isExpanded) {
                filterByCategory(categoryName, event);
            }
        }

        function openRecipeFromMenu(recipeIndex) {
            const recipe = allRecipes[recipeIndex];
            if (recipe) {
                openRecipeModal(recipe);
                closeSidebar(); // Fermer la sidebar sur mobile
            }
        }

        function filterByCategory(category, event) {
            activeCategory = category;

            // Mettre √† jour les items actifs dans la sidebar
            if (event) {
                document.querySelectorAll('.category-item').forEach(item => {
                    item.classList.remove('active');
                });
                event.target.closest('.category-item').classList.add('active');
            }

            // Filtrer les recettes
            if (category === 'all') {
                filteredRecipes = allRecipes;
            } else {
                filteredRecipes = allRecipes.filter(recipe => recipe.categorie === category);
            }

            // Appliquer aussi le filtre de recherche si pr√©sent
            const searchTerm = document.getElementById('searchInput').value;
            if (searchTerm) {
                filterRecipes();
            } else {
                displayRecipes(filteredRecipes);
            }
        }

        // Fonctions pour g√©rer la sidebar sur mobile
        function toggleSidebar() {
            const sidebar = document.getElementById('sidebar');
            const overlay = document.getElementById('sidebarOverlay');
            sidebar.classList.toggle('open');
            overlay.classList.toggle('show');
        }

        function closeSidebar() {
            const sidebar = document.getElementById('sidebar');
            const overlay = document.getElementById('sidebarOverlay');
            sidebar.classList.remove('open');
            overlay.classList.remove('show');
        }

        function displayRecipes(recipes) {
            const recipesGrid = document.getElementById('recipesGrid');
            recipesGrid.innerHTML = '';

            recipes.forEach(recipe => {
                const card = document.createElement('div');
                card.className = 'recipe-card';
                
                let infoItems = '';
                if (recipe.portions) infoItems += `<span class="recipe-info-item">üë• ${recipe.portions}</span>`;
                if (recipe.tempsPreparation) infoItems += `<span class="recipe-info-item">‚è±Ô∏è ${recipe.tempsPreparation}</span>`;
                if (recipe.tempsCuisson) infoItems += `<span class="recipe-info-item">üî• ${recipe.tempsCuisson}</span>`;
                if (recipe.difficulte) infoItems += `<span class="recipe-info-item">üìä ${recipe.difficulte}</span>`;

                let html = `
                    <div class="recipe-name">${recipe.nom || 'Sans nom'}</div>
                    ${recipe.categorie ? `<span class="recipe-category">${recipe.categorie}</span>` : ''}
                    ${infoItems ? `<div class="recipe-info">${infoItems}</div>` : ''}
                `;

                // Affichage des ingr√©dients (avec ou sans sections)
                if (recipe.ingredientsSections && recipe.ingredientsSections.length > 0) {
                    html += `<div class="recipe-section"><strong>üìã Ingr√©dients :</strong></div>`;
                    recipe.ingredientsSections.forEach(section => {
                        html += `
                            <div class="recipe-subsection">
                                <strong class="section-title">${section.title} :</strong>
                                <p style="white-space: pre-line;">${section.content}</p>
                            </div>
                        `;
                    });
                } else if (recipe.ingredients) {
                    html += `
                        <div class="recipe-section">
                            <strong>üìã Ingr√©dients :</strong>
                            <p style="white-space: pre-line;">${recipe.ingredients}</p>
                        </div>
                    `;
                }

                // Bouton pour voir les d√©tails
                html += `
                    <div style="margin-top: 15px; padding-top: 15px; border-top: 1px solid #eee; text-align: center;">
                        <span style="color: #667eea; font-size: 0.9em; font-weight: 500;">
                            üëÅÔ∏è Cliquez pour voir la pr√©paration compl√®te
                        </span>
                    </div>
                `;

                card.innerHTML = html;
                card.onclick = () => openRecipeModal(recipe);
                recipesGrid.appendChild(card);
            });
        }

        function openRecipeModal(recipe) {
            const modal = document.getElementById('recipeModal');
            const content = document.getElementById('modalRecipeContent');
            
            let infoItems = '';
            if (recipe.portions) infoItems += `<span class="modal-info-item">üë• ${recipe.portions}</span>`;
            if (recipe.tempsPreparation) infoItems += `<span class="modal-info-item">‚è±Ô∏è ${recipe.tempsPreparation}</span>`;
            if (recipe.tempsCuisson) infoItems += `<span class="modal-info-item">üî• ${recipe.tempsCuisson}</span>`;
            if (recipe.difficulte) infoItems += `<span class="modal-info-item">üìä ${recipe.difficulte}</span>`;

            let html = `
                <div class="modal-recipe-name">${recipe.nom || 'Sans nom'}</div>
                ${recipe.categorie ? `<span class="modal-recipe-category">${recipe.categorie}</span>` : ''}
                ${infoItems ? `<div class="modal-recipe-info">${infoItems}</div>` : ''}
            `;

            // Ajusteur de portions
            const originalPortions = extractPortionNumber(recipe.portions);
            if (originalPortions && (recipe.ingredientsSections || recipe.ingredients)) {
                html += `
                    <div class="portion-adjuster collapsed" id="portionAdjuster">
                        <div class="portion-adjuster-header" onclick="togglePortionAdjuster()">
                            <div class="portion-adjuster-header-text">
                                <span>üî¢</span>
                                <span>Ajuster les quantit√©s</span>
                            </div>
                            <span class="portion-adjuster-toggle-icon">‚ñº</span>
                        </div>
                        <div class="portion-adjuster-content">
                            <div class="edit-mode-banner">
                                ‚úèÔ∏è Mode √©dition actif : Cliquez sur les quantit√©s pour les modifier
                            </div>
                            <div class="portion-adjuster-title">
                                Nombre de portions
                            </div>
                            <div class="portion-controls">
                                <button class="portion-btn" onclick="adjustPortion(-1)">‚àí</button>
                                <div class="portion-display">
                                    <div class="portion-number" id="currentPortions">${originalPortions}</div>
                                    <div class="portion-label">personne(s)</div>
                                    <div class="portion-original">Original : ${recipe.portions}</div>
                                </div>
                                <button class="portion-btn" onclick="adjustPortion(1)">+</button>
                            </div>
                            <center>
                                <button class="portion-reset-btn" onclick="resetPortions()">‚Üª R√©initialiser</button>
                                <button class="edit-mode-toggle-btn" id="editModeToggle" onclick="toggleEditMode()">
                                    <span id="editModeIcon">‚úèÔ∏è</span>
                                    <span id="editModeText">Modifier les quantit√©s</span>
                                </button>
                            </center>
                        </div>
                    </div>
                `;
            }

            // Affichage des ingr√©dients (avec IDs pour l'ajustement)
            if (recipe.ingredientsSections && recipe.ingredientsSections.length > 0) {
                html += `<div class="modal-section"><div class="modal-section-title">üìã Ingr√©dients</div>`;
                recipe.ingredientsSections.forEach((section, index) => {
                    html += `
                        <div class="modal-subsection">
                            <div class="modal-subsection-title">${section.title}</div>
                            <p id="ingredients-section-${index}">${section.content}</p>
                        </div>
                    `;
                });
                html += `</div>`;
            } else if (recipe.ingredients) {
                html += `
                    <div class="modal-section">
                        <div class="modal-section-title">üìã Ingr√©dients</div>
                        <p id="ingredients-simple">${recipe.ingredients}</p>
                    </div>
                `;
            }

            // Affichage de la pr√©paration
            if (recipe.preparationSections && recipe.preparationSections.length > 0) {
                html += `<div class="modal-section"><div class="modal-section-title">üë®‚Äçüç≥ Pr√©paration</div>`;
                recipe.preparationSections.forEach(section => {
                    html += `
                        <div class="modal-subsection">
                            <div class="modal-subsection-title">${section.title}</div>
                            <p>${section.content}</p>
                        </div>
                    `;
                });
                html += `</div>`;
            } else if (recipe.preparation) {
                html += `
                    <div class="modal-section">
                        <div class="modal-section-title">üë®‚Äçüç≥ Pr√©paration</div>
                        <p>${recipe.preparation}</p>
                    </div>
                `;
            }

            // Notes
            if (recipe.notes) {
                html += `
                    <div class="modal-section">
                        <div class="modal-section-title">üí° Notes</div>
                        <p style="font-style: italic;">${recipe.notes}</p>
                    </div>
                `;
            }

            // Source
            if (recipe.source) {
                html += `
                    <div style="margin-top: 30px; padding-top: 20px; border-top: 1px solid #e0e0e0; font-size: 0.9em; color: #999;">
                        Source : ${recipe.source}
                    </div>
                `;
            }

            // Bouton mode √©tape par √©tape (uniquement si il y a des √©tapes de pr√©paration)
            if ((recipe.preparationSections && recipe.preparationSections.length > 0) || recipe.preparation) {
                html += `
                    <button class="activate-step-mode-btn" onclick="startStepByStep()">
                        ‚ñ∂Ô∏è Mode √âtape par √âtape
                    </button>
                `;
            }

            content.innerHTML = html;
            
            // Stocker la recette pour le mode √©tape par √©tape
            currentRecipeForStepMode = recipe;
            
            // Stocker les donn√©es originales pour l'ajustement de portions
            storeOriginalPortionData(recipe);
            
            // Pr√©parer le contenu du drawer pour mobile
            prepareIngredientsDrawer(recipe);
            
            modal.classList.add('active');
            document.body.style.overflow = 'hidden'; // Emp√™cher le scroll du body
            
            // Cacher le bouton menu sur mobile
            const menuToggle = document.getElementById('menuToggle');
            if (menuToggle) menuToggle.style.display = 'none';
        }

        function prepareIngredientsDrawer(recipe) {
            const drawerContent = document.getElementById('drawerIngredientsContent');
            const openBtn = document.getElementById('openIngredientsBtn');
            
            if (!recipe.ingredientsSections && !recipe.ingredients) {
                openBtn.style.display = 'none';
                return;
            }
            
            let html = '';
            
            // Affichage des ingr√©dients dans le drawer avec quantit√©s ajust√©es
            if (recipe.ingredientsSections && recipe.ingredientsSections.length > 0) {
                recipe.ingredientsSections.forEach((section, index) => {
                    const adjustedContent = getAdjustedIngredientsContent(`ingredients-section-${index}`);
                    html += `
                        <div class="drawer-section">
                            <div class="drawer-section-title">${section.title}</div>
                            <div class="drawer-content">${adjustedContent || section.content}</div>
                        </div>
                    `;
                });
            } else if (recipe.ingredients) {
                const adjustedContent = getAdjustedIngredientsContent('ingredients-simple');
                html += `
                    <div class="drawer-section">
                        <div class="drawer-content">${adjustedContent || recipe.ingredients}</div>
                    </div>
                `;
            }
            
            drawerContent.innerHTML = html;
            openBtn.style.display = window.innerWidth <= 768 ? 'flex' : 'none';
        }

        function getAdjustedIngredientsContent(ingredientId) {
            const element = document.getElementById(ingredientId);
            if (!element) return null;
            
            // Extraire le texte des quantit√©s ajust√©es (sans les indicateurs)
            const lines = [];
            element.querySelectorAll('.ingredient-line').forEach(line => {
                // Cloner le n≈ìud pour manipulation
                const clone = line.cloneNode(true);
                
                // Supprimer les indicateurs de modification
                const indicators = clone.querySelectorAll('.ingredient-modified-indicator');
                indicators.forEach(ind => ind.remove());
                
                let text = clone.textContent.trim();
                if (text) {
                    // Ne pas ajouter de tiret si la ligne commence d√©j√† par un
                    if (!text.startsWith('-')) {
                        text = '- ' + text;
                    }
                    lines.push(text);
                }
            });
            
            return lines.length > 0 ? lines.join('<br>') : null;
        }

        function openIngredientsDrawer() {
            document.getElementById('ingredientsDrawer').classList.add('open');
            document.getElementById('ingredientsDrawerOverlay').classList.add('show');
        }

        function closeIngredientsDrawer() {
            document.getElementById('ingredientsDrawer').classList.remove('open');
            document.getElementById('ingredientsDrawerOverlay').classList.remove('show');
        }

        function closeRecipeModal() {
            const modal = document.getElementById('recipeModal');
            modal.classList.remove('active');
            document.body.style.overflow = 'auto';
            
            // Fermer aussi le drawer et masquer le bouton
            closeIngredientsDrawer();
            document.getElementById('openIngredientsBtn').style.display = 'none';
            
            // R√©afficher le bouton menu sur mobile
            const menuToggle = document.getElementById('menuToggle');
            if (menuToggle) menuToggle.style.display = '';
            
            // R√©initialiser le mode √©dition
            editModeActive = false;
        }

        // Fermer la modal avec la touche √âchap
        document.addEventListener('keydown', (e) => {
            if (e.key === 'Escape') {
                const stepMode = document.getElementById('stepByStepMode');
                const stepDrawer = document.getElementById('stepIngredientsDrawer');
                
                // Si le drawer du mode √©tape par √©tape est ouvert, le fermer
                if (stepDrawer.classList.contains('open')) {
                    closeStepIngredientsDrawer();
                }
                // Sinon, si le mode √©tape par √©tape est actif, le fermer
                else if (stepMode.classList.contains('active')) {
                    closeStepByStep();
                } 
                // Sinon, fermer la modal normale
                else {
                    closeRecipeModal();
                }
            }
        });

        // ============================================
        // FONCTIONS MODE √âTAPE PAR √âTAPE
        // ============================================

        function startStepByStep() {
            if (!currentRecipeForStepMode) return;
            
            // Fermer la modal normale
            closeRecipeModal();
            
            // Pr√©parer les donn√©es
            stepByStepData.recipe = currentRecipeForStepMode;
            stepByStepData.steps = parseStepsFromRecipe(currentRecipeForStepMode);
            stepByStepData.currentStepIndex = 0;
            
            // Pr√©parer le drawer avec tous les ingr√©dients
            prepareStepIngredientsDrawer(currentRecipeForStepMode);
            
            // Afficher le mode
            document.getElementById('stepByStepMode').classList.add('active');
            document.getElementById('stepHeaderTitle').textContent = currentRecipeForStepMode.nom || 'Recette';
            document.body.style.overflow = 'hidden';
            
            // Afficher la premi√®re √©tape
            displayCurrentStep();
        }

        function prepareStepIngredientsDrawer(recipe) {
            const drawerContent = document.getElementById('stepDrawerContent');
            const ingredientsBtn = document.getElementById('stepAllIngredientsBtn');
            
            // V√©rifier s'il y a des ingr√©dients
            if (!recipe.ingredientsSections && !recipe.ingredients) {
                ingredientsBtn.style.display = 'none';
                return;
            }
            
            let html = '';
            
            // Si on a des sections d'ingr√©dients avec quantit√©s ajust√©es
            if (recipe.ingredientsSections && recipe.ingredientsSections.length > 0) {
                recipe.ingredientsSections.forEach((section, index) => {
                    const adjustedContent = getAdjustedIngredientsContent(`ingredients-section-${index}`);
                    html += `
                        <div class="step-drawer-section">
                            <div class="step-drawer-section-title">${section.title}</div>
                            <div class="step-drawer-section-content">${adjustedContent || section.content}</div>
                        </div>
                    `;
                });
            } 
            // Sinon, utiliser les ingr√©dients simples avec quantit√©s ajust√©es
            else if (recipe.ingredients) {
                const adjustedContent = getAdjustedIngredientsContent('ingredients-simple');
                html += `
                    <div class="step-drawer-section">
                        <div class="step-drawer-section-title">Ingr√©dients</div>
                        <div class="step-drawer-section-content">${adjustedContent || recipe.ingredients}</div>
                    </div>
                `;
            }
            
            drawerContent.innerHTML = html;
            ingredientsBtn.style.display = 'flex';
        }

        function openStepIngredientsDrawer() {
            document.getElementById('stepIngredientsDrawer').classList.add('open');
            document.getElementById('stepDrawerOverlay').classList.add('show');
        }

        function closeStepIngredientsDrawer() {
            document.getElementById('stepIngredientsDrawer').classList.remove('open');
            document.getElementById('stepDrawerOverlay').classList.remove('show');
        }

        function parseStepsFromRecipe(recipe) {
            let steps = [];
            
            // Si la recette a des sections de pr√©paration
            if (recipe.preparationSections && recipe.preparationSections.length > 0) {
                recipe.preparationSections.forEach(section => {
                    // Trouver les ingr√©dients correspondants avec quantit√©s ajust√©es
                    let sectionIngredients = null;
                    let ingredientSectionId = null;
                    
                    if (recipe.ingredientsSections) {
                        const foundIndex = recipe.ingredientsSections.findIndex(
                            ing => ing.title.toLowerCase() === section.title.toLowerCase()
                        );
                        
                        if (foundIndex !== -1) {
                            ingredientSectionId = `ingredients-section-${foundIndex}`;
                            // R√©cup√©rer le contenu ajust√© depuis le DOM
                            const adjustedContent = getAdjustedIngredientsContent(ingredientSectionId);
                            sectionIngredients = adjustedContent || recipe.ingredientsSections[foundIndex].content;
                        }
                    }
                    
                    // S√©parer les √©tapes (par num√©ro ou tiret)
                    const stepLines = section.content.split('\n').filter(line => line.trim());
                    stepLines.forEach(line => {
                        const cleaned = line.replace(/^\d+\.\s*/, '').replace(/^-\s*/, '').trim();
                        if (cleaned) {
                            steps.push({
                                sectionTitle: section.title,
                                text: cleaned,
                                ingredients: sectionIngredients
                            });
                        }
                    });
                });
            } 
            // Sinon, utiliser la pr√©paration simple
            else if (recipe.preparation) {
                const stepLines = recipe.preparation.split('\n').filter(line => line.trim());
                // R√©cup√©rer les ingr√©dients ajust√©s
                const adjustedIngredients = getAdjustedIngredientsContent('ingredients-simple');
                const ingredientsToUse = adjustedIngredients || recipe.ingredients || null;
                
                stepLines.forEach(line => {
                    const cleaned = line.replace(/^\d+\.\s*/, '').replace(/^-\s*/, '').trim();
                    if (cleaned) {
                        steps.push({
                            sectionTitle: 'Pr√©paration',
                            text: cleaned,
                            ingredients: ingredientsToUse
                        });
                    }
                });
            }
            
            return steps;
        }

        function displayCurrentStep() {
            const step = stepByStepData.steps[stepByStepData.currentStepIndex];
            const totalSteps = stepByStepData.steps.length;
            const currentIndex = stepByStepData.currentStepIndex + 1;
            
            // Mise √† jour du compteur et de la barre de progression
            document.getElementById('stepCounter').textContent = `√âtape ${currentIndex}/${totalSteps}`;
            const progressPercent = (currentIndex / totalSteps) * 100;
            document.getElementById('stepProgressFill').style.width = progressPercent + '%';
            
            // Mise √† jour du contenu
            document.getElementById('stepSectionTitle').textContent = step.sectionTitle;
            document.getElementById('stepText').textContent = step.text;
            
            // Afficher les ingr√©dients si disponibles
            const ingredientsBox = document.getElementById('stepIngredientsBox');
            if (step.ingredients) {
                document.getElementById('stepIngredientsList').textContent = step.ingredients;
                ingredientsBox.style.display = 'block';
            } else {
                ingredientsBox.style.display = 'none';
            }
            
            // Mise √† jour des boutons de navigation
            document.getElementById('stepPrevBtn').disabled = currentIndex === 1;
            
            const nextBtn = document.getElementById('stepNextBtn');
            if (currentIndex === totalSteps) {
                nextBtn.textContent = '‚úì Terminer';
                nextBtn.classList.remove('step-next-btn');
                nextBtn.classList.add('step-finish-btn');
            } else {
                nextBtn.textContent = 'Suivant ‚Üí';
                nextBtn.classList.remove('step-finish-btn');
                nextBtn.classList.add('step-next-btn');
            }
            nextBtn.disabled = false;
        }

        function previousStep() {
            if (stepByStepData.currentStepIndex > 0) {
                stepByStepData.currentStepIndex--;
                displayCurrentStep();
            }
        }

        function nextStep() {
            if (stepByStepData.currentStepIndex < stepByStepData.steps.length - 1) {
                stepByStepData.currentStepIndex++;
                displayCurrentStep();
            } else {
                // Derni√®re √©tape : fermer le mode
                closeStepByStep();
            }
        }

        function backToRecipe() {
            // Sauvegarder la recette avant de fermer
            const recipe = currentRecipeForStepMode;
            
            // Fermer le mode √©tape par √©tape
            closeStepByStep();
            
            // Rouvrir la modal de la recette
            if (recipe) {
                openRecipeModal(recipe);
            }
        }

        function closeStepByStep() {
            // Fermer le drawer s'il est ouvert
            closeStepIngredientsDrawer();
            
            // Cacher le bouton des ingr√©dients
            document.getElementById('stepAllIngredientsBtn').style.display = 'none';
            
            // Fermer le mode
            document.getElementById('stepByStepMode').classList.remove('active');
            document.body.style.overflow = 'auto';
            stepByStepData = {
                recipe: null,
                steps: [],
                currentStepIndex: 0
            };
        }

        // ============================================
        // FONCTIONS D'IMPORT CSV
        // ============================================

        function openImportModal() {
            document.getElementById('importModal').classList.add('active');
            document.getElementById('csvTextarea').value = '';
            document.getElementById('importStatus').className = 'import-status';
            document.getElementById('importStatus').textContent = '';
            document.body.style.overflow = 'hidden';
        }

        function closeImportModal() {
            document.getElementById('importModal').classList.remove('active');
            document.body.style.overflow = 'auto';
        }

        async function importRecipeFromCSV() {
            const csvData = document.getElementById('csvTextarea').value.trim();
            const statusDiv = document.getElementById('importStatus');
            
            if (!csvData) {
                statusDiv.className = 'import-status error';
                statusDiv.textContent = '‚ùå Veuillez coller le CSV avant d\'importer.';
                return;
            }

            // Afficher le statut de chargement
            statusDiv.className = 'import-status loading';
            statusDiv.textContent = '‚è≥ Import en cours...';

            try {
                const response = await fetch(webAppUrl, {
                    method: 'POST',
                    mode: 'no-cors',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        action: 'importRecipe',
                        csvData: csvData
                    })
                });

                // Avec mode no-cors, on ne peut pas lire la r√©ponse
                // On consid√®re que c'est un succ√®s si pas d'erreur
                statusDiv.className = 'import-status success';
                statusDiv.textContent = `‚úÖ Recette envoy√©e ! Rechargement...`;
                
                // Recharger les recettes apr√®s 2 secondes
                setTimeout(() => {
                    loadRecipes();
                    closeImportModal();
                }, 2000);
                
            } catch (error) {
                statusDiv.className = 'import-status error';
                statusDiv.textContent = `‚ùå Erreur : ${error.message}. V√©rifiez que votre Web App est bien d√©ploy√©.`;
                console.error('D√©tails de l\'erreur:', error);
            }
        }

        // Fermer la modal d'import avec la touche √âchap
        document.addEventListener('keydown', (e) => {
            if (e.key === 'Escape') {
                const importModal = document.getElementById('importModal');
                if (importModal.classList.contains('active')) {
                    closeImportModal();
                    return;
                }
            }
        });

        function filterRecipes() {
            const searchTerm = document.getElementById('searchInput').value.toLowerCase();
            
            let recipesToFilter = activeCategory === 'all' ? allRecipes : filteredRecipes;

            if (searchTerm === '') {
                displayRecipes(recipesToFilter);
                return;
            }

            const filtered = recipesToFilter.filter(recipe => {
                return (
                    (recipe.nom && recipe.nom.toLowerCase().includes(searchTerm)) ||
                    (recipe.categorie && recipe.categorie.toLowerCase().includes(searchTerm)) ||
                    (recipe.ingredients && recipe.ingredients.toLowerCase().includes(searchTerm)) ||
                    (recipe.preparation && recipe.preparation.toLowerCase().includes(searchTerm)) ||
                    (recipe.difficulte && recipe.difficulte.toLowerCase().includes(searchTerm))
                );
            });

            if (filtered.length === 0) {
                document.getElementById('recipesGrid').innerHTML = '<div class="no-results">Aucune recette ne correspond √† votre recherche</div>';
            } else {
                displayRecipes(filtered);
            }
        }

        // ===== Fonctions d'ajustement de portions =====
        let originalPortionData = {
            portions: 0,
            ingredients: [],
            allQuantities: [] // Stocke toutes les quantit√©s originales avec leur position
        };

        let globalRatio = 1.0; // Ratio global appliqu√© √† toutes les quantit√©s
        let editModeActive = false; // Mode √©dition des quantit√©s activ√© ou non

        function extractPortionNumber(portionStr) {
            if (!portionStr) return null;
            const match = portionStr.match(/(\d+)/);
            return match ? parseInt(match[1]) : null;
        }

        function adjustPortion(delta) {
            const currentEl = document.getElementById('currentPortions');
            if (!currentEl) return;

            let current = parseInt(currentEl.textContent);
            let newValue = current + delta;

            // Minimum 1 portion
            if (newValue < 1) newValue = 1;

            // Calculer le nouveau ratio global
            globalRatio = newValue / originalPortionData.portions;

            // Mettre √† jour toutes les quantit√©s
            updateAllQuantities();
            
            // Mettre √† jour l'affichage des portions
            currentEl.textContent = newValue;
        }

        function resetPortions() {
            const currentEl = document.getElementById('currentPortions');
            if (!currentEl) return;

            // R√©initialiser le ratio global
            globalRatio = 1.0;

            // Mettre √† jour toutes les quantit√©s
            updateAllQuantities();

            // R√©initialiser l'affichage des portions
            currentEl.textContent = originalPortionData.portions;

            // Supprimer tous les indicateurs de modification
            document.querySelectorAll('.ingredient-modified-indicator').forEach(el => el.remove());
        }

        function adjustQuantitiesInText(text, ratio) {
            let adjustedText = text;

            // Traiter les fractions d'abord
            adjustedText = adjustedText.replace(/(\d+)\/(\d+)/g, (match, numerator, denominator) => {
                const originalValue = parseInt(numerator) / parseInt(denominator);
                const newValue = originalValue * ratio;
                // Essayer de garder une repr√©sentation fractionnaire
                return formatNumberOrFraction(newValue);
            });

            // Traiter les nombres avec unit√©s
            adjustedText = adjustedText.replace(/(\d+(?:[.,]\d+)?)\s*(g|kg|ml|l|cl|dl|c\.|cuill√®res?|c√†s|c√†c|tasses?|pinc√©es?|sachets?|pot|pots)?/gi, 
                (match, number, unit) => {
                    const originalValue = parseFloat(number.replace(',', '.'));
                    const newValue = originalValue * ratio;
                    const formattedNumber = formatNumber(newValue);
                    
                    // Mettre en √©vidence les quantit√©s ajust√©es
                    const highlighted = `<span class="ingredient-adjusted">${formattedNumber}</span>`;
                    return unit ? `${highlighted} ${unit}` : highlighted;
                }
            );

            return adjustedText;
        }

        function formatNumber(num) {
            // Arrondir intelligemment
            if (num < 1) {
                // Pour les petites quantit√©s, garder 2 d√©cimales
                return num.toFixed(2).replace(/\.?0+$/, '');
            } else if (num < 10) {
                // Pour les quantit√©s moyennes, 1 d√©cimale
                return num.toFixed(1).replace(/\.?0+$/, '');
            } else {
                // Pour les grandes quantit√©s, arrondir √† l'entier
                return Math.round(num).toString();
            }
        }

        function formatNumberOrFraction(num) {
            // Essayer de trouver une fraction simple pour les petits nombres
            const commonFractions = [
                { value: 1/4, display: '1/4' },
                { value: 1/3, display: '1/3' },
                { value: 1/2, display: '1/2' },
                { value: 2/3, display: '2/3' },
                { value: 3/4, display: '3/4' },
                { value: 1, display: '1' },
                { value: 1.25, display: '1 1/4' },
                { value: 1.33, display: '1 1/3' },
                { value: 1.5, display: '1 1/2' },
                { value: 1.67, display: '1 2/3' },
                { value: 1.75, display: '1 3/4' },
                { value: 2, display: '2' },
                { value: 2.5, display: '2 1/2' },
                { value: 3, display: '3' },
                { value: 3.5, display: '3 1/2' }
            ];

            // Chercher une fraction proche (tol√©rance de 0.05)
            for (let frac of commonFractions) {
                if (Math.abs(num - frac.value) < 0.05) {
                    return frac.display;
                }
            }

            // Sinon, utiliser le formatage normal
            return formatNumber(num);
        }

        function storeOriginalPortionData(recipe) {
            const portions = extractPortionNumber(recipe.portions);
            if (!portions) return;

            originalPortionData.portions = portions;
            originalPortionData.ingredients = [];
            originalPortionData.allQuantities = [];
            globalRatio = 1.0;
            editModeActive = false; // R√©initialiser le mode √©dition

            // Stocker les ingr√©dients sectionn√©s
            if (recipe.ingredientsSections && recipe.ingredientsSections.length > 0) {
                recipe.ingredientsSections.forEach((section, index) => {
                    originalPortionData.ingredients.push({
                        id: `ingredients-section-${index}`,
                        content: section.content
                    });
                });
            } else if (recipe.ingredients) {
                // Stocker les ingr√©dients simples
                originalPortionData.ingredients.push({
                    id: 'ingredients-simple',
                    content: recipe.ingredients
                });
            }

            // Pr√©parer les quantit√©s (non √©ditables par d√©faut)
            setTimeout(() => makeQuantitiesEditable(), 100);
        }

        function makeQuantitiesEditable() {
            originalPortionData.allQuantities = [];
            let quantityIndex = 0;

            originalPortionData.ingredients.forEach(({ id }) => {
                const element = document.getElementById(id);
                if (!element) return;

                // Diviser le contenu en lignes
                const lines = element.innerHTML.split('<br>').filter(line => line.trim());
                
                let newHTML = lines.map((line) => {
                    // Traiter directement sans placeholders - une seule passe
                    let processedLine = line;
                    const replacements = [];
                    
                    // Trouver toutes les quantit√©s (fractions ET nombres)
                    // Pattern combin√© pour capturer tout
                    const pattern = /(\d+)\/(\d+)|(\d+(?:[.,]\d+)?)/g;
                    let match;
                    let lastIndex = 0;
                    let result = '';
                    
                    while ((match = pattern.exec(processedLine)) !== null) {
                        // Ajouter le texte avant le match
                        result += processedLine.substring(lastIndex, match.index);
                        
                        if (match[1] && match[2]) {
                            // C'est une fraction (groupe 1 et 2)
                            const numerator = parseInt(match[1]);
                            const denominator = parseInt(match[2]);
                            const originalValue = numerator / denominator;
                            const qId = `qty-${quantityIndex}`;
                            
                            originalPortionData.allQuantities.push({
                                id: qId,
                                value: originalValue,
                                unit: '',
                                isFraction: true,
                                numerator: numerator,
                                denominator: denominator
                            });
                            
                            quantityIndex++;
                            
                            result += `<span class="editable-quantity" id="${qId}" data-original="${originalValue}" data-unit="" data-fraction="${numerator}/${denominator}">${numerator}/${denominator}</span>`;
                        } else if (match[3]) {
                            // C'est un nombre d√©cimal ou entier (groupe 3)
                            const number = match[3];
                            const originalValue = parseFloat(number.replace(',', '.'));
                            const qId = `qty-${quantityIndex}`;
                            
                            originalPortionData.allQuantities.push({
                                id: qId,
                                value: originalValue,
                                unit: '',
                                isFraction: false
                            });
                            
                            quantityIndex++;
                            
                            result += `<span class="editable-quantity" id="${qId}" data-original="${originalValue}" data-unit="">${number}</span>`;
                        }
                        
                        lastIndex = pattern.lastIndex;
                    }
                    
                    // Ajouter le reste du texte
                    result += processedLine.substring(lastIndex);
                    
                    return `<div class="ingredient-line">${result}</div>`;
                }).join('');

                element.innerHTML = newHTML;
            });
        }

        function togglePortionAdjuster() {
            const adjuster = document.getElementById('portionAdjuster');
            if (adjuster) {
                adjuster.classList.toggle('collapsed');
            }
        }

        function toggleEditMode() {
            editModeActive = !editModeActive;
            
            const adjuster = document.getElementById('portionAdjuster');
            const toggleBtn = document.getElementById('editModeToggle');
            const icon = document.getElementById('editModeIcon');
            const text = document.getElementById('editModeText');
            
            if (editModeActive) {
                // Activer le mode √©dition
                adjuster.classList.add('edit-mode-active');
                toggleBtn.classList.add('active');
                icon.textContent = 'üîí';
                text.textContent = 'Verrouiller les quantit√©s';
                
                // Rendre les quantit√©s √©ditables
                originalPortionData.allQuantities.forEach(qty => {
                    const el = document.getElementById(qty.id);
                    if (el) {
                        el.contentEditable = 'true';
                        el.onblur = () => handleQuantityChange(qty.id);
                        el.onkeydown = (e) => handleQuantityKeydown(e, qty.id);
                    }
                });
            } else {
                // D√©sactiver le mode √©dition
                adjuster.classList.remove('edit-mode-active');
                toggleBtn.classList.remove('active');
                icon.textContent = '‚úèÔ∏è';
                text.textContent = 'Modifier les quantit√©s';
                
                // Rendre les quantit√©s non √©ditables
                originalPortionData.allQuantities.forEach(qty => {
                    const el = document.getElementById(qty.id);
                    if (el) {
                        el.contentEditable = 'false';
                        el.onblur = null;
                        el.onkeydown = null;
                    }
                });
            }
        }

        function handleQuantityKeydown(event, qId) {
            if (event.key === 'Enter') {
                event.preventDefault();
                event.target.blur(); // D√©clenche onblur
            }
            if (event.key === 'Escape') {
                event.preventDefault();
                // Restaurer la valeur originale
                const el = document.getElementById(qId);
                if (el) {
                    const originalValue = parseFloat(el.dataset.original);
                    const adjustedValue = originalValue * globalRatio;
                    el.textContent = formatNumber(adjustedValue);
                    el.blur();
                }
            }
        }

        function handleQuantityChange(qId) {
            const el = document.getElementById(qId);
            if (!el) return;

            let newText = el.textContent.trim().replace(',', '.');
            let newValue;
            
            // Essayer de parser comme fraction (ex: "1/2", "3/4")
            const fractionMatch = newText.match(/^(\d+)\/(\d+)$/);
            if (fractionMatch) {
                const numerator = parseInt(fractionMatch[1]);
                const denominator = parseInt(fractionMatch[2]);
                newValue = numerator / denominator;
            } 
            // Essayer de parser comme fraction mixte (ex: "1 1/2", "2 3/4")
            else {
                const mixedMatch = newText.match(/^(\d+)\s+(\d+)\/(\d+)$/);
                if (mixedMatch) {
                    const whole = parseInt(mixedMatch[1]);
                    const numerator = parseInt(mixedMatch[2]);
                    const denominator = parseInt(mixedMatch[3]);
                    newValue = whole + (numerator / denominator);
                } else {
                    // Parser comme nombre d√©cimal
                    newValue = parseFloat(newText);
                }
            }
            
            // Validation
            if (isNaN(newValue) || newValue <= 0) {
                // Restaurer la valeur pr√©c√©dente
                const qty = originalPortionData.allQuantities.find(q => q.id === qId);
                if (qty) {
                    const adjustedValue = qty.value * globalRatio;
                    if (qty.isFraction && Math.abs(globalRatio - 1.0) < 0.01) {
                        el.textContent = `${qty.numerator}/${qty.denominator}`;
                    } else {
                        el.textContent = formatNumber(adjustedValue);
                    }
                }
                return;
            }

            // Trouver la quantit√© originale
            const qty = originalPortionData.allQuantities.find(q => q.id === qId);
            if (!qty) return;

            // Calculer le nouveau ratio global bas√© sur ce changement
            const newRatio = newValue / qty.value;

            // Si le ratio a chang√© significativement
            if (Math.abs(newRatio - globalRatio) > 0.01) {
                globalRatio = newRatio;
                
                // Appliquer le nouveau ratio √† TOUTES les quantit√©s
                updateAllQuantities();
                
                // Mettre √† jour le nombre de portions
                updatePortionDisplay();
            }
        }

        function updateAllQuantities() {
            originalPortionData.allQuantities.forEach(qty => {
                const el = document.getElementById(qty.id);
                if (!el) return;

                const newValue = qty.value * globalRatio;
                
                // Si c'est une fraction et que le ratio est proche de 1, garder la fraction originale
                if (qty.isFraction && Math.abs(globalRatio - 1.0) < 0.01) {
                    el.textContent = `${qty.numerator}/${qty.denominator}`;
                } else if (qty.isFraction) {
                    // Pour les fractions ajust√©es, afficher en d√©cimal ou essayer de trouver une fraction simple
                    el.textContent = formatNumberOrFraction(newValue);
                } else {
                    el.textContent = formatNumber(newValue);
                }
                
                // Ajouter un indicateur si modifi√©
                if (Math.abs(globalRatio - 1.0) > 0.01) {
                    if (!el.nextElementSibling || !el.nextElementSibling.classList.contains('ingredient-modified-indicator')) {
                        const indicator = document.createElement('span');
                        indicator.className = 'ingredient-modified-indicator';
                        indicator.title = `√ó${globalRatio.toFixed(2)}`;
                        el.parentNode.insertBefore(indicator, el.nextSibling);
                    }
                } else {
                    const indicator = el.nextElementSibling;
                    if (indicator && indicator.classList.contains('ingredient-modified-indicator')) {
                        indicator.remove();
                    }
                }
            });

            // Mettre √† jour les drawers et le mode √©tape par √©tape avec les nouvelles quantit√©s
            if (currentRecipeForStepMode) {
                prepareIngredientsDrawer(currentRecipeForStepMode);
                prepareStepIngredientsDrawer(currentRecipeForStepMode);
                
                // Rafra√Æchir l'√©tape courante dans le mode √©tape par √©tape si actif
                if (stepByStepData.recipe) {
                    stepByStepData.steps = parseStepsFromRecipe(currentRecipeForStepMode);
                    if (document.getElementById('stepByStepMode').classList.contains('active')) {
                        displayCurrentStep();
                    }
                }
            }
        }

        function updatePortionDisplay() {
            const currentEl = document.getElementById('currentPortions');
            if (!currentEl) return;

            const newPortions = Math.round(originalPortionData.portions * globalRatio);
            currentEl.textContent = newPortions;
        }
    </script>
</body>
</html>

